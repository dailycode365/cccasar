"use strict";const e=require("util"),n=require("../lib/tasks");let t,i,a,o,r={RECORD:!1,DIRTY:!1,PLAYING:!1},c={aNode:null,rNode:null,component:null,animation:null,recordDumps:null,undoDump:null,time:0},d=function(e,n){if(!c.animation)return 0;let t=cc.engine.getInstanceById(c.component).getAnimationState(c.animation).clip;if(t&&r.DIRTY){let i=[Editor.T("MESSAGE.save"),Editor.T("MESSAGE.cancel"),Editor.T("MESSAGE.dont_save")];n&&i.splice(1,1),e=Editor.Dialog.messageBox({type:"warning",buttons:i,title:Editor.T("MESSAGE.animation_editor.save_confirm_title"),message:Editor.T("MESSAGE.animation_editor.save_confirm_message",{name:t.name}),detail:Editor.T("MESSAGE.animation_editor.save_confirm_detail"),defaultId:0,cancelId:n?void 0:1,noLink:!0}),n&&1===e&&(e=2)}return e},s=function(e){let n=cc.engine.getInstanceById(c.component).getAnimationState(c.animation).clip;cc.AssetLibrary.loadAsset(n._uuid,async(t,i)=>{if(t)return Editor.error(t),e&&e();r.DIRTY=!1;let a=i.serialize();Editor.Ipc.sendToAll("scene:animation-clip-changed",{uuid:n._uuid,data:a,clip:i.name,dirty:!1}),await f({clip:i.name,data:a,dirty:!1}),e&&e()})},m=function(e){if(!c.rNode)return!1;for(;e;){if(e.uuid===c.rNode)return!0;e=e.parent}return!1},l=function(e){if(!c.animation)return;e=e||cc.engine.getInstanceById(c.aNode);let n=cc.engine.getInstanceById(c.component).getAnimationState(c.animation).clip;if(!e||!n)return;let t=_Scene.gizmosView,i="";if(e.uuid!==c.rNode){i=e.name;let n=e.parent;for(;n.uuid!==c.rNode;)i=`${n.name}/${i}`,n=n.parent;if(!n)return Editor.error("Can't generate child path for node."),void 0}e.trajectoryGizmo||(e.trajectoryGizmo=new _Scene.gizmos.trajectory(t,e)),e.trajectoryGizmo.show(cc.engine.getInstanceById(c.rNode),n,i)},p=function(e){(e=e||cc.engine.getInstanceById(c.aNode))&&e.trajectoryGizmo&&e.trajectoryGizmo.hide()},u=function(e){r.PLAYING=!1,_Scene.gizmosView.hidden=!1,cc.engine.getInstanceById(c.component).getAnimationState(c.animation).on("stop",u),Editor.Ipc.sendToAll("scene:animation-state-changed",{clip:e.name,state:"stop"})},g=function(){if(!c.animation||!c.component)return!1;_Scene.gizmosView.hidden=!1;let e=cc.engine.getInstanceById(c.component).getAnimationState(c.animation);e.off("stop",u);e.getWrappedInfo(e.time);e.pause(),cc.engine.animatingInEditMode=!1,r.PLAYING=!1,Editor.Ipc.sendToAll("scene:animation-state-changed",{clip:e.name,state:"pause"})},f=async function(n){if(!c.animation)return;r.PLAYING&&g();let t=cc.engine.getInstanceById(c.component).getAnimationState(n.clip);if(!t||n.clip!==c.animation)return;try{let i=await e.promisify(cc.AssetLibrary.loadAsset)(t.clip._uuid);n.dirty=Editor.serialize(i)!==n.data}catch(e){Editor.warn(e),n.dirty=!0}let i=function(e,n){return(e&n)===n};return new Promise((e,t)=>{cc.AssetLibrary.loadJson(n.data,(n,i)=>{if(n)return t(n);e(i)})}).then(e=>{let n=c.time;if(n>e.duration&&(n=e.duration),t.wrapMode!==e.wrapMode){t.getWrappedInfo(n);t.isPlaying&&!t.isPaused?i(e.wrapMode,cc.WrapMode.Reverse)&&(n=Math.abs(n-e.duration)):i(e.wrapMode,cc.WrapMode.Reverse)!=i(e.wrapMode,cc.WrapMode.Reverse)&&(n=Math.abs(n-e.duration))}else i(t.wrapMode,cc.WrapMode.Reverse)&&(n=Math.abs(n-e.duration));return t.setTime(n),Promise.resolve(e)}).then(e=>{let n=cc.engine.getInstanceById(c.component);n._init();let t=null;for(let i in n._nameToState){let a=n._nameToState[i],o=a.clip;if(o===e||o&&e&&(o.name===e.name||o._uuid===e._uuid)){e._uuid=e._uuid||o._uuid,t=a;break}}if(!t)return cc.error(`Can't find state from clip [${e.name}]`);let i=n._clips.indexOf(t.clip);n._clips[i]=e,t.name!==e.name&&(delete n._nameToState[t.name],n._nameToState[e.name]=t,t._name=e.name),t._clip=e,n._animator._reloadClip(t)}).then(e=>{cc.engine.getInstanceById(c.component).getAnimationState(c.animation).sample(),p(),l(),r.DIRTY=void 0===n.dirty||"undefined"===n.dirty||n.dirty,cc.engine.repaintInEditMode()}).catch(e=>{Editor.error(e)})},y=function(e){if(!r.DIRTY)return e&&e();if(r.DIRTY=!1,!c.animation)return e&&e();let n=cc.engine.getInstanceById(c.component).getAnimationState(c.animation).clip;_Scene.Undo.save(),Editor.assetdb.queryUrlByUuid(n._uuid,(t,i)=>{Editor.Ipc.sendToMain("asset-db:save-exists",i,n.serialize(),e)})};t=i=a=o=function(){};const I=[{type:"cc.Vec2",name:"position"},{type:"Float",name:"x"},{type:"Float",name:"y"},{type:"cc.Vec2",name:"scale"},{type:"Float",name:"scaleX"},{type:"Float",name:"scaleY"},{type:"Float",name:"angle"},{type:"Float",name:"width"},{type:"Float",name:"height"},{type:"cc.Color",name:"color"},{type:"Float",name:"opacity"},{type:"Float",name:"anchorX"},{type:"Float",name:"anchorY"},{type:"Float",name:"skewX"},{type:"Float",name:"skewY"}];let E=function(e,n,t,i){if(!i.properties||!i.properties[n]||Array.isArray(e))return null;let a,o=i.properties[n],r=o.type;return e&&e.type&&(r=e.type,delete e.type),!1===o.visible||!1===o.visible||"cc.Node"===r||!1===o.animatable?null:a=cc.js.getClassByName(t)?t+"."+n:i.name+"."+n};module.exports={STATE:r,Cache:c,confirm:d,restoreClip:s,contains:m,activate:function(e){c.aNode=e.uuid,r.RECORD&&m(e)&&l(e)},deactivate:function(e){c.aNode&&c.aNode===e.uuid&&(c.aNode=null),p(e)},showTrajectoryGizmo:l,hideTrajectoryGizmo:p,isPlaying:function(){return r.PLAYING},setAnimationTime:function(e){if(!r.RECORD||!c.animation||!c.component)return!1;let n=cc.engine.getInstanceById(c.component).getAnimationState(c.animation);return r.PLAYING||(n.play(),n.pause()),c.time=e,e>n.duration&&(e=n.duration),(n.wrapMode&cc.WrapMode.Reverse)===cc.WrapMode.Reverse&&(e=n.duration-e),n.setTime(e),n.sample(),cc.engine.repaintInEditMode(),!0},getAnimationTime:function(e){if(!c.animation)return 0;let n=cc.engine.getInstanceById(c.component).getAnimationState(c.animation);return n.getWrappedInfo(n.time).time},setAnimationSpeed:function(e){if(!c.animation)return!1;cc.engine.getInstanceById(c.component).getAnimationState(c.animation).speed=e},playAnimation:function(){if(!c.animation||!c.component)return!1;_Scene.gizmosView.hidden=!0;let e=cc.engine.getInstanceById(c.component),n=e.getAnimationState(c.animation),t=n.getWrappedInfo(n.time);n.isPaused&&t.time>=n.duration&&n.setTime(0),e.play(n.name),n.on("stop",u),cc.engine.animatingInEditMode=!0,r.PLAYING=!0,Editor.Ipc.sendToAll("scene:animation-state-changed",{clip:n.name,state:"play"})},pauseAnimation:g,mountClip:function(e,n){let t;if(e){let n=cc.engine.getInstanceById(e);t=n.getComponent(cc.Animation)}else t=cc.engine.getInstanceById(c.component);if(!t)return!1;cc.AssetLibrary.loadAsset(n,(e,n)=>{if(e)return Editor.warn(e);t.addClip(n)})},updateClip:f,switchClip:function(e,t){if(!e)return t&&t(new Error("The clip's name cannot be empty."));let i=(e,n)=>{if(!e||!c.rNode)return n&&n();let t=cc.engine.getInstanceById(c.component),i=t.getAnimationState(e);if(!i)return n&&n(new Error(`The corresponding clip cannot be found - ${e}`));c.animation=e,t.play(e),t.pause(e);let a=c.time;a>i.duration&&(a=i.duration),i.setTime(a);let o=i.clip;if(!o)return n&&n(new Error(`Animation switch failed - ${e}`));Editor.assetdb.queryUrlByUuid(o._uuid,(e,n)=>{_Scene.updateTitle(n),exports.title=n}),i.sample(),l(),Editor.Ipc.sendToAll("scene:animation-current-clip-changed",e),n&&n()},a=function(){n.push({name:"animation-change-current-clip",target:this,run:i,params:[e]},t)};if(!c.animation)return a();let o=d(0,!0);if(1===o)return Editor.Ipc.sendToAll("scene:animation-current-clip-changed",c.animation),void 0;0===o?y(a):s(a)},save:y,onAddComponent:t,onRemoveComponent:i,assetChanged:a,assetsMoved:o,recordNodeChanged:function(e,n){if(!r.RECORD||!e||!e.length)return;let t=e[0];n instanceof cc.Component&&n.constructor&&n!==t.getComponent(n.constructor)||("string"==typeof t&&(e=e.map(e=>cc.engine.getInstanceById(e))),Editor.Ipc.sendToWins("editor:record-node-changed",e.map(e=>({id:e.uuid,dump:Editor.getNodeDump(e)}))))},queryEditProperties:function(e,n){let t=[],i=e.value,a=e.types;return n&&t.push({name:"active",type:"cc.Boolean"}),I.forEach(e=>{t.push(e)}),i.__comps__.forEach(e=>{if("cc.Animation"!==e.type){for(let n=0;n<t.length;++n)if(t[n].name.startsWith(e.type))return;(function(e,n){let t=[],i=e.type;if(!i)return Editor.warn("Type can not be null"),void 0;let a=n[i],o=e.value;for(let e in o){if("type"===e||"__scriptAsset"===e)continue;let n=E(o,e,i,a);null!==n&&t.push({type:o[e].type||null,name:n})}return t})(e,a).forEach(e=>{t.push(e)})}}),t}};