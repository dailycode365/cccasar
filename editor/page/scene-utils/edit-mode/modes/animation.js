"use strict";require("../../lib/tasks");const e=require("../../utils/animation"),n=require("../../lib/sandbox");let o=e.STATE,t=e.Cache;module.exports={name:"animation",title:"",open:function(e){if(o.RECORD)return e&&e();o.RECORD=!0;let i=cc.engine.getInstanceById(t.aNode);for(;i&&!i.getComponent(cc.Animation);){if(i.parent instanceof cc.Scene){i=node;break}i=i.parent}t.rNode=i.uuid,Editor.Ipc.sendToAll("scene:animation-record-changed",!0,i.uuid),i&&(t.component=i.getComponent(cc.Animation).uuid),cc.engine.editingRootNode=i.uuid;let c=Object.create(null);_Scene.walk(i,!0,e=>{let n=c[e.uuid]=_Scene._UndoImpl.recordNode(e),o=e.getComponent(cc.Animation);o&&delete n.comps[o.uuid]}),t.recordDumps=n.registerReloadableData(c),t.undoDump=n.registerReloadableData(_Scene.Undo.dump()),_Scene.Undo.clear(),e&&e()},softReload:function(e,n){},save:e.save,beforePushOther:function(e){require("../index").popAll()},confirmClose:function(n){return n=void 0===n?2:n,e.confirm(n)},close:function(i,c){if(!o.RECORD)return c&&c();if(o.RECORD=!1,1===i)return c&&c();let a={save(){e.save(()=>{a.exit()})},doNotSave(){e.restoreClip(()=>{a.exit()})},exit(){cc.engine.getInstanceById(t.component).getAnimationState(t.animation).setTime(0),e.pauseAnimation(),cc.engine.updateAnimatingInEditMode(),e.hideTrajectoryGizmo(),Editor.Ipc.sendToAll("scene:animation-record-changed",!1);let o=n.popReloadableData(t.recordDumps);for(let e in o){let n=cc.engine.getInstanceById(e),t=o[e],i=n._children.slice();_Scene._UndoImpl.restoreNode(n,t),n._children=i}return cc.engine.editingRootNode="",_Scene.Undo.restore(n.popReloadableData(t.undoDump)),t.undoDump=null,t.recordDumps=null,t.animation=null,t.component=null,c&&c()}};0===i?a.save():a.doNotSave()},dirty:function(){return o.DIRTY}};