var e=require("fire-url");const t=require("../../utils/prefab"),r=require("../../utils/node");var i="",n="",c=null,o="",a=[];function s(){_Scene.StashInPage.restore(c),o="",a.length>0&&setTimeout(function(){for(var e=0;e<a.length;e++)_Scene.syncPrefab(a[e]);a.length=0},400)}var d={name:"prefab",title:"",open(e,r){cc.AssetLibrary.loadAsset(e,(a,d)=>{if(a)return cc.error(a);(function(){var e=new cc.SceneAsset;e.scene=cc.director.getScene(),o=Editor.serialize(e,{stringify:!0}),c=_Scene.StashInPage.dump(),_Scene.Undo.clear()})();var l,u=new cc.Scene;try{l=cc.instantiate(d),Editor.globalProfile.data["auto-sync-prefab"]&&t._setPrefabSync(l,!0)}catch(e){return s(),r(e)}n=l.uuid,l.parent=u,cc.director.runSceneImmediate(u),Editor.Selection.select("node",n,!0,!0),function(){var e=cc.engine.getInstanceById(n);if(e){var t=cc.director.getScene();t.position=cc.Vec2.ZERO,t.scale=1;var r=e.getBoundingBoxToWorld();_Scene.view.adjustToCenter(50,r)}}(),i=e,Editor.assetdb.queryUrlByUuid(e,(e,t)=>{_Scene.updateTitle(t),this.title=t,r()})})},confirmClose:function(){let t=2;if(n&&i&&this.dirty()){var r=cc.engine.getInstanceById(n),c=r&&r.name;if(!c){var o=Editor.assetdb.remote.uuidToUrl(i);c=e.basename(o)}t=Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.save"),Editor.T("MESSAGE.cancel"),Editor.T("MESSAGE.dont_save")],title:Editor.T("MESSAGE.prefab_editor.save_confirm_title"),message:Editor.T("MESSAGE.prefab_editor.save_confirm_message",{name:c}),detail:Editor.T("MESSAGE.prefab_editor.save_confirm_detail"),defaultId:0,cancelId:1,noLink:!0})}return t},close:function(e,t){switch(e){case 0:this.save(()=>{this.closeWithoutSave(),t()});break;case 1:t&&t();break;case 2:this.closeWithoutSave(),t&&t()}},beforePushOther(e,t){if(e===this){require("../index").popAll()}},checkRootNodes(){for(var e=cc.director.getScene(),t=cc.engine.getInstanceById(n),i=0;i<e.children.length;i++){if(e.children[i]!==t){var c=r.getNodePath(t);Editor.info(Editor.T("MESSAGE.prefab_editor.only_save_prefab",{node:c}));break}}},closeWithoutSave(){if(!i)return Editor.error("no editing prefab");i="",n="",s()},save(e){this.checkRootNodes(),_Scene.Undo.save(),_Scene.applyPrefab(n),e&&setTimeout(e,200)},getPreviewScene:()=>o,prefabAssetChanged(e){a.push(e)},dirty:()=>_Scene.Undo.dirty()};module.exports=d;