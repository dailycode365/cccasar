var t=cc.Class.Attr.DELIMETER,r="A$$ETprops"+t+"A$$ETprops";function e(t){this.owner=t,this.watchingInfos=Object.create(null)}var s=Object.create(null);function n(t,r){var e=function(t,r){for(;t;){var e=Object.getOwnPropertyDescriptor(t,r);if(e)return{owner:t,pd:e};t=Object.getPrototypeOf(t)}return null}(t,r);if(!e)return console.warn("Failed to get property descriptor of %s.%s",t,r),void 0;var n=e.pd;if(!1===n.configurable)return console.warn("Failed to register notifier for %s.%s",t,r),void 0;if("value"in n)return console.warn("Cannot watch instance variable of %s.%s",t,r),void 0;var a=n.set;n.set=function(t,e){if(a.call(this,t,e),this._watcherHandle&&this._watcherHandle!==s){var n="";t instanceof cc.Asset?n=t._uuid:"string"==typeof t&&(n=Editor.Utils.UuidCache.urlToUuid(t)),this._watcherHandle.changeWatchAsset(r,n)}},Object.defineProperty(e.owner,r,n)}function a(t,r,e){var s=cc.js.getPropertyDescriptor(t,r);if(s&&s.set){s.set.call(t,e,!0)}}e.initComponent=function(t){t._watcherHandle=null},e.initHandle=function(a){var c=cc.Class.Attr.getClassAttrs(a.constructor)[r];void 0===c&&(c=function(r){for(var e=null,s=r.constructor,a=cc.Class.Attr.getClassAttrs(s),c=0,i=s.__props__;c<i.length;c++){var o=i[c],l=o+t;if(a[l+"hasSetter"]&&a[l+"hasGetter"]){var u=r[o];(u instanceof cc.Asset||cc.js.isChildClassOf(a[l+"ctor"],cc.RawAsset)||null==u)&&(n(r,o),e?e.push(o):e=[o])}}return e}(a),cc.Class.Attr.setClassAttr(a.constructor,"A$$ETprops","A$$ETprops",c)),a._watcherHandle=c?new e(a):s},e.start=function(t){t._watcherHandle||e.initHandle(t),t._watcherHandle!==s&&t._watcherHandle.start()},e.stop=function(t){t._watcherHandle&&t._watcherHandle!==s&&t._watcherHandle.stop()},e.prototype.start=function(){for(var t=this.owner,e=cc.Class.Attr.getClassAttrs(t.constructor)[r],s=0;s<e.length;s++){var n,c=e[s],i=t[c];if(i instanceof cc.Asset&&i._uuid?n=i._uuid:"string"==typeof i&&i&&(n=Editor.Utils.UuidCache.urlToUuid(i),i),n){var o=a.bind(null,t,c);cc.AssetLibrary.assetListener.add(n,o),this.watchingInfos[c]={uuid:n,callback:o}}}},e.prototype.stop=function(){for(var t in this.watchingInfos){var r=this.watchingInfos[t];r&&cc.AssetLibrary.assetListener.remove(r.uuid,r.callback)}this.watchingInfos=Object.create(null)},e.prototype.changeWatchAsset=function(t,r){var e=this.watchingInfos[t];if(e){if(e.uuid===r)return;this.watchingInfos[t]=null,cc.AssetLibrary.assetListener.remove(e.uuid,e.callback)}if(r){var s=a.bind(null,this.owner,t);cc.AssetLibrary.assetListener.add(r,s),this.watchingInfos[t]={uuid:r,callback:s}}},module.exports=e;