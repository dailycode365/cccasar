"use strict";const t=Editor.require("scene://utils/node"),e=Editor.require("scene://utils/animation");let i=Editor.GizmosUtils.snapPixelWihVec2,s=1e-6;function r(t,e){return Math.abs(t-e)<s}let o=cc.vmath.mat4.create();module.exports=class{constructor(t,e){this.target=e,this.hovering=!1,this.selecting=!1,this.editing=!1,this._view=t,this._root=null,this._hidden=!0,this._adjustMap=[],this.registerAdjustValue(cc.Vec2,["x","y"]),this.registerAdjustValue(cc.Size,["width","height"]),this._dirty=!0,this._lastMats={},this.init&&this.init()}layer(){return"scene"}createRoot(){let t=this._view[this.layer()];if(!t)return Editor.warn(`Plase make gizmo layer exists [${this.layer()}] in Gizmo View`),void 0;this._root=t.group(),this._registerEvent(),this.onCreateRoot&&this.onCreateRoot()}registerMoveSvg(t,e,i){i?Editor.GizmosUtils.addMoveHandles(t,i,this.createMoveCallbacks(e)):Editor.GizmosUtils.addMoveHandles(t,this.createMoveCallbacks(e))}createMoveCallbacks(t){this._moveCallbacks||(this._moveCallbacks=this.onCreateMoveCallbacks());let e=this._moveCallbacks,i=!1;return{start:function(s,r,o){i=!1,r=cc.view.getCanvasSize().height-r;let n=Array.prototype.slice.call(arguments,2,arguments.length);n=[s,r].concat(n),n=void 0!==t?n.concat(t):n,e.start&&e.start.apply(this,n)}.bind(this),update:function(s,r,o){if(0===s&&0===r)return;i=!0,r=-r,this.recordChanges();let n=Array.prototype.slice.call(arguments,2,arguments.length);n=[s,r].concat(n),n=void 0!==t?n.concat(t):n,e.update&&e.update.apply(this,n),this._view.repaintHost()}.bind(this),end:function(s){let r=Array.prototype.slice.call(arguments,0,arguments.length);r=void 0!==t?r.concat(t):r,e.end&&e.end.apply(this,r),i&&this.commitChanges(),i=!1}.bind(this)}}onCreateMoveCallbacks(){return{start(t,e,i){},update(t,e,i){},end(t){}}}recordChanges(){this.nodes.forEach(t=>{_Scene.Undo.recordNode(t.uuid)}),this._dirty=!0}commitChanges(){e.recordNodeChanged(this.nodes),_Scene.Undo.commit(),this._dirty=!0}worldToPixel(t){return i(this._view.worldToPixel(t))}pixelToWorld(t){return this._view.pixelToWorld(t)}sceneToPixel(t){return i(this._view.sceneToPixel(t))}pixelToScene(t){return this._view.pixelToScene(t)}defaultMinDifference(){return Editor.Math.numOfDecimalsF(1/this._view.scale)}registerAdjustValue(t,e){this._adjustMap.push({ctor:t,keys:e})}_checkLockStatus(){return this.node._objFlags&cc.Object.Flags.LockedInEditor}adjustValue(t,e,i){Array.isArray(t)||(t=[t]),void 0===e||Array.isArray(e)||(e=[e]),i=i||this.defaultMinDifference();let s=(t,e)=>{if(e&&"number"==typeof t[e])return t[e]=Editor.Math.toPrecision(t[e],i),void 0;{let i=e?t[e]:t,r=this._adjustMap;for(let t=0;t<r.length;t++){let e=r[t];if(i===e.ctor||i.constructor===e.ctor){for(let t=0;t<e.keys.length;t++)s(i,e.keys[t]);return}}}Editor.warn(`Try to adjust non-number value [${e}}]`)};for(let i=0;i<t.length;i++){let r=t[i];if(void 0===e)s(r);else for(let t=0;t<e.length;t++)s(r,e[t])}}targetValid(){let t=this.target;return Array.isArray(t)&&(t=t[0]),t&&t.isValid}visible(){return this.selecting||this.editing}_viewDirty(){let e=cc.director.getScene(),i=t.getWorldPosition(e),s=this._view.worldToPixel(i),o=!1;return this._lastMapping&&r(this._lastMapping.x,s.x)&&r(this._lastMapping.y,s.y)||(o=!0),this._lastMapping=s,o}_nodeDirty(t){(t=t||this.node).getWorldMatrix(o);let e=!1,i=this._lastMats[t.uuid];return i?r(i.a,o.a)&&r(i.b,o.b)&&r(i.c,o.c)&&r(i.d,o.d)&&r(i.tx,o.tx)&&r(i.ty,o.ty)||(e=!0):(this._lastMats[t.uuid]=i=cc.vmath.mat4.create(),e=!0),cc.vmath.mat4.copy(i,o),e}dirty(){return this._viewDirty()||this._nodeDirty()||this._dirty}update(){if(!this.targetValid()||!this.visible()||this._checkLockStatus())return this.hide(),void 0;if(this.show(),!this.dirty())return;let t=cc.director&&cc.director.getScene();this.onUpdate&&t&&this.onUpdate(),this._dirty=!1}remove(){this._root&&(this._root.remove(),this._root=null)}ensureRoot(){this._root||this.createRoot()}hide(){this._hidden||(this._root&&this._root.hide(),this._hidden=!0,this._dirty=!0)}show(){this._hidden&&(this.ensureRoot(),this._root&&this._root.show(),this._hidden=!1,this._dirty=!0)}rectHitTest(t,e){return!1}_registerEvent(){let t=this._root.node;t.addEventListener("mousedown",()=>{let t=this.nodes.map(t=>t.uuid);Editor.Selection.select("node",t)},!0),t.addEventListener("mouseover",()=>{Editor.Selection.hover("node",this.node.uuid)},!0),t.addEventListener("mouseleave",()=>{Editor.Selection.hover("node",null)},!0),t.addEventListener("mousemove",t=>{t.srcElement.instance.ignoreMouseMove||t.stopPropagation()})}get node(){let t=this.target;return Array.isArray(t)&&(t=t[0]),cc.Node.isNode(t)?t:t instanceof cc.Component?t.node:null}get nodes(){let t=[],e=this.target;if(Array.isArray(e))for(let i=0;i<e.length;++i){let s=e[i];cc.Node.isNode(s)?t.push(s):s instanceof cc.Component&&t.push(s.node)}else cc.Node.isNode(e)?t.push(e):e instanceof cc.Component&&t.push(e.node);return t}get topNodes(){return this.target.filter(t=>{let e=t.parent;for(;e;){if(-1!==this.target.indexOf(e))return!1;e=e.parent}return!0})}get selecting(){return this._selecting}set selecting(t){this._dirty=t!==this._selecting,this._selecting=t}get editing(){return this._editing}set editing(t){this._dirty=t!==this._editing,this._editing=t}get hovering(){return this._hovering}set hovering(t){this._dirty=t!==this._hovering,this._hovering=t}};