"use strict";const t=Editor.require("scene://utils/node");let e=require("./collider-gizmo"),o=require("../tools"),r=o.rectTool.Type,i=cc.vmath.mat4.create();module.exports=class extends e{onCreateMoveCallbacks(){let t,e,o=this;function i(i,s,l,c){let n=s.clone(),h=o.node,a=o.target,y=cc.vmath.mat4.create();h.getWorldMatrix(y),cc.vmath.mat4.invert(y,y),y.m12=y.m13=0;let d=cc.v2(),x=cc.v2();cc.vmath.vec2.transformMat4(d,s,y),cc.vmath.vec2.transformMat4(x,n,y),function(t,e,o,i,s){return t===r.Right||t===r.RightTop||t===r.RightBottom?(s&&(i.x/=1-e.x),o.x=i.x*e.x):(s&&(i.x/=e.x),o.x=i.x*(1-e.x)),t===r.LeftBottom||t===r.Bottom||t===r.RightBottom?(s&&(i.y/=1-e.y),o.y=i.y*e.y):(s&&(i.y/=e.y),o.y=i.y*(1-e.y)),o}(i,cc.v2(.5,.5),d,x,c),function(t,e,o,i){t===r.LeftBottom?o.x*=-1:t===r.LeftTop?(o.x*=-1,o.y*=-1):t===r.RightTop?o.y*=-1:t===r.Left?(o.x*=-1,i||(e.y=o.y=0)):t===r.Right?i||(e.y=o.y=0):t===r.Top?(o.y*=-1,i||(e.x=o.x=0)):t===r.Bottom&&(i||(e.x=o.x=0))}(i,d,x,l),l&&(x.y=x.x*(e.height/e.width));let g=cc.size(e.width+x.x,e.height+x.y);c||(g.width<0&&(d.x-=g.width/2),g.height<0&&(d.y-=g.height/2),d=t.add(d),a.offset=d),g.width<0&&(g.width=0),g.height<0&&(g.height=0),a.size=g}return{start:()=>{t=this.target.offset.clone(),e=this.target.size.clone()},update:(e,s,l,c)=>{let n=new cc.Vec2(e,s);if(c===r.Center)(function(e){let r=o.node,i=cc.vmath.mat4.create();r.getWorldMatrix(i),cc.vmath.mat4.invert(i,i),i.m12=i.m13=0;let s=cc.v2();cc.vmath.vec2.transformMat4(s,e,i),s.addSelf(t),o.target.offset=s})(n.clone());else{let t=!!l&&l.shiftKey,e=!!l&&l.altKey;i(c,n.clone(),t,e)}},end:(t,e,i)=>{if(!t)return;let s=o.target;i===r.Center?this.adjustValue(s,["offset"]):this.adjustValue(s,["offset","size"])}}}onCreateRoot(){let t,e,i,s,l,c,n,h,a,y,d=this._root,x=d.sideGroup=d.group().style("pointer-events","none");d.dragArea=y=d.polygon("0,0,0,0,0,0").fill({color:"rgba(0,128,255,0.2)"}).stroke("none").style("pointer-events","fill"),this.registerMoveSvg(y,r.Center);let g=(t,e)=>o.lineTool(x,cc.v2(0,0),cc.v2(0,0),"#7fc97a",e,this.createMoveCallbacks(t)).style("cursor",e);e=g(r.Left,"col-resize"),i=g(r.Top,"row-resize"),s=g(r.Right,"col-resize"),l=g(r.Bottom,"row-resize"),(t=d.sidePointGroup=d.group()).hide();let f=(t,e,r)=>o.circleTool(e,5,{color:"#7fc97a"},null,this.createMoveCallbacks(t)).style("cursor",r);c=f(r.LeftBottom,t,"nwse-resize"),n=f(r.LeftTop,t,"nesw-resize"),h=f(r.RightTop,t,"nwse-resize"),a=f(r.RightBottom,t,"nesw-resize"),d.plot=(t=>{y.plot([[t[0].x,t[0].y],[t[1].x,t[1].y],[t[2].x,t[2].y],[t[3].x,t[3].y]]),e.plot(t[0].x,t[0].y,t[1].x,t[1].y),i.plot(t[1].x,t[1].y,t[2].x,t[2].y),s.plot(t[2].x,t[2].y,t[3].x,t[3].y),l.plot(t[3].x,t[3].y,t[0].x,t[0].y),this._targetEditing&&(c.center(t[0].x,t[0].y),n.center(t[1].x,t[1].y),h.center(t[2].x,t[2].y),a.center(t[3].x,t[3].y))})}onUpdate(){let e=this.target,o=e.size,r=e.offset,s=cc.rect(r.x-o.width/2,r.y-o.height/2,o.width,o.height);this.node.getWorldMatrix(i);let l=t.getObbFromRect(i,s);l[0]=this.worldToPixel(l[0]),l[1]=this.worldToPixel(l[1]),l[2]=this.worldToPixel(l[2]),l[3]=this.worldToPixel(l[3]),this._root.plot(l)}enterEditing(){let t=this._root;t.sideGroup.style("pointer-events","stroke"),t.dragArea.style("cursor","move"),t.sidePointGroup.show()}leaveEditing(){let t=this._root;t.sideGroup.style("pointer-events","none"),t.dragArea.style("cursor",null),t.sidePointGroup.hide()}};