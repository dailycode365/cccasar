"use strict";let t=require("./collider-gizmo"),e=require("../tools"),o={None:0,Point:1,Line:2};module.exports=class extends t{onCreateMoveCallbacks(){let t,e;return{start:(l,r,i,n)=>{if(n===o.Point){let o=i.currentTarget.instance;if(e=o.point.origin,t=e.clone(),i.ctrlKey||i.metaKey){this.recordChanges();let t=this.target.points;return t.splice(t.indexOf(e),1),this.commitChanges(),void 0}}else if(n===o.Line){this.recordChanges();let t=this.node.convertToNodeSpace(cc.v2(l,r)),e=i.currentTarget.instance,o=e.startSvgPoint.point.origin,n=e.endSvgPoint.point.origin,s=this.target.points.indexOf(o)+1,c=o.x-n.x,a=o.y-n.y,h=(t.x-o.x)*(o.x-n.x)+(t.y-o.y)*(o.y-n.y);h/=c*c+a*a,t.x=o.x+h*c,t.y=o.y+h*a,this.adjustValue(t),this.target.points.splice(s,0,t),this.commitChanges()}},update:(l,r,i,n)=>{let s=cc.vmath.mat4.create();if(this.node.getWorldMatrix(s),cc.vmath.mat4.invert(s,s),s.m12=s.m13=0,n===o.Point){if(i.ctrlKey||i.metaKey)return;let o=cc.v2(l,r);cc.vmath.vec2.transformMat4(o,o,s),o.addSelf(t),this.adjustValue(o),e.x=o.x,e.y=o.y}}}}onCreateRoot(){let t=this._root,l=t.linesGroup=t.group(),r=[];l.style("cursor","normal");let i=()=>e.lineTool(l,cc.v2(0,0),cc.v2(0,0),"#7fc97a",null,this.createMoveCallbacks(o.Line)),n=t.pointsGroup=t.group(),s=[];n.hide();let c=()=>{let t=e.circleTool(n,5,{color:"#7fc97a"},null,"pointer",this.createMoveCallbacks(o.Point));return t.on("mouseover",function(e){(e.ctrlKey||e.metaKey)&&(t.fill({color:"#f00"}),t.l1&&t.l1.stroke({color:"#f00"}),t.l2&&t.l2.stroke({color:"#f00"}))}),t.on("mouseout",function(e){t.fill({color:"#7fc97a"}),t.l1&&t.l1.stroke({color:"#7fc97a"}),t.l2&&t.l2.stroke({color:"#7fc97a"})}),t};t.plot=function(t){let e=[];for(let o=0,l=t.length;o<l;o++){let n=t[o];e.push([n.x,n.y]);let a=s[o];if(a||(a=s[o]=c()),a.point=n,a.show(),a.center(n.x,n.y),o===l-1)continue;let h=o+1,u=s[h];u||(u=s[h]=c());let p=r[o];p||(p=r[o]=i());let g=n,d=t[h];p.show(),p.plot(g.x,g.y,d.x,d.y),p.startSvgPoint=a,p.endSvgPoint=u,a.l1=p,u.l2=p}for(let e=t.length,o=s.length;e<o;e++)s[e].hide();for(let e=t.length-1,o=s.length;e<o;e++)r[e]&&r[e].hide()}}onUpdate(){let t=this.target.points,e=(this.node,cc.vmath.mat4.create());this.node.getWorldMatrix(e);let o=[];for(let l=0,r=t.length;l<r;l++){let r=t[l],i=cc.v2();cc.vmath.vec2.transformMat4(i,r,e),(i=this.worldToPixel(i)).origin=t[l],o.push(i)}this._root.plot(o)}enterEditing(){let t=this._root;t.pointsGroup.show(),t.linesGroup.style("cursor","copy")}leaveEditing(){let t=this._root;t.pointsGroup.hide(),t.linesGroup.style("cursor","normal")}};