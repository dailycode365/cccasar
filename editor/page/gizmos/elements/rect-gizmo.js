"use strict";const t=Editor.require("scene://utils/node");let e=require("./tools"),o=e.rectTool.Type,i=Editor.GizmosUtils.snapPixelWihVec2,r=cc.vmath,n=cc.v2,h=r.mat4.create(),s=new n,l=new n;module.exports=class extends Editor.Gizmo{init(){this._processing=!1,this._rect=cc.rect(0,0,0,0),this._tool=null}layer(){return"foreground"}onCreateMoveCallbacks(){let e=[],i=[],a=[],c=[],d=[],g=this;function x(t,e,i,r){t===o.LeftBottom?i.x*=-1:t===o.LeftTop?(i.x*=-1,i.y*=-1):t===o.RightTop?i.y*=-1:t===o.Left?(i.x*=-1,r||(e.y=i.y=0)):t===o.Right?r||(e.y=i.y=0):t===o.Top?(i.y*=-1,r||(e.x=i.x=0)):t===o.Bottom&&(r||(e.x=i.x=0))}function u(t,e,i,r,n){return t===o.Right||t===o.RightTop||t===o.RightBottom?(n&&(r.x/=1-e.x),i.x=r.x*e.x):(n&&(r.x/=e.x),i.x=r.x*(1-e.x)),t===o.LeftBottom||t===o.Bottom||t===o.RightBottom?(n&&(r.y/=1-e.y),i.y=r.y*e.y):(n&&(r.y/=e.y),i.y=r.y*(1-e.y)),i}return{start:()=>{e.length=0,a.length=0,i.length=0,c.length=0,d.length=0,d.tempRect=function(t){return cc.rect(t[1].x,t[1].y,t[3].x-t[1].x,t[3].y-t[1].y)}(g.getBounds()),g._processing=!0;for(let o=0,r=g.target.length;o<r;++o){let r=g.target[o];e.push(t.getWorldPosition(r)),i.push(r.position),a.push(r.getContentSize()),c.push(r.getAnchorPoint()),d.push(t.getWorldBounds(r))}},update:(y,m,f,p)=>{let w=new cc.Vec2(y,m);if(p===o.Anchor)(function(o){let i=g.target[0],n=i.getContentSize();s.set(i._position);let a=e[0].add(o);t.setWorldPosition(i,a),i.getLocalMatrix(h),r.mat4.invert(h,h),h.m12=0,h.m13=0,l.x=i.x,l.y=i.y,l.subSelf(s),r.vec2.transformMat4(l,l,h),l.x=l.x/n.width,l.y=l.y/n.height,s.x=i.anchorX,s.y=i.anchorY,s.addSelf(l),i.setAnchorPoint(s)})(w.clone());else if(p===o.Center)(function(t){let o=g.target.length;for(let i=0;i<o;++i){let o=g.target[i],n=(e[i],o.getContentSize()),l=c[i];s.x=s.y=0;let a=o.parent.convertToNodeSpaceAR(s),d=o.parent.convertToNodeSpaceAR(t);a.sub(d,d),o.getLocalMatrix(h),r.mat4.invert(h,h),h.m12=0,h.m13=0,r.vec2.transformMat4(d,d,h),d.x=d.x/n.width,d.y=d.y/n.height,l.add(d,s),o.setAnchorPoint(s)}})(w.clone());else{let o=!!f&&f.shiftKey,s=!!f&&f.altKey;g.target.length>1?function(o,i,h,s){let l=d.tempRect;h&&(i.y=i.x*(l.height/l.width));let c=i.clone();x(o,i,c,h),u(o,s?n(.5,.5):n(0,0),i,c,s);let y=l.clone();y.x=l.x-i.x,y.y=l.y-i.y,y.width=l.width+c.x,y.height=l.height+c.y,g._rect=y;for(let o=0,i=g.target.length;o<i;o++){let i=g.target[o],h=e[o],s=(h.x-l.x)/l.width,x=(h.y-l.y)/l.height;t.setWorldPosition(i,n(y.x+s*y.width,y.y+x*y.height));let u=d[o],m=u.width/l.width,f=u.height/l.height,p=a[o],w=p.width>0?1:-1,v=p.height>0?1:-1,M=c.clone();M.x=M.x*m*w,M.y=M.y*f*v;let _=r.mat4.create();i.getWorldMatrix(_),r.mat4.invert(_,_),_.m12=_.m13=0,_.m00=Math.abs(_.m00),_.m01=Math.abs(_.m01),_.m04=Math.abs(_.m04),_.m05=Math.abs(_.m05),r.vec2.transformMat4(M,M,_),i.setContentSize(cc.size(p.width+M.x,p.height+M.y))}}(p,w.clone(),o,s):function(t,e,o,n){let s=a[0];o&&(e.y=e.x*(s.height/s.width));let l=e.clone(),c=i[0],d=g.target[0];d.getWorldMatrix(h),r.mat4.invert(h,h),h.m12=h.m13=0;let y=r.vec2.transformMat4(cc.v2(),e,h),m=r.vec2.transformMat4(cc.v2(),l,h);u(t,d.getAnchorPoint(),y,m,n),x(t,y,m,o),n||(d.getLocalMatrix(h),h.m12=h.m13=0,r.vec2.transformMat4(y,y,h),d.position=c.add(y)),d.setContentSize(cc.size(s.width+m.x,s.height+m.y))}(p,w.clone(),o,s)}},end:(t,e,i)=>{if(t)if(i<o.Center)this.adjustValue(node,["anchorX","anchorY"]);else if(i===o.Anchor){let t=g.target[0];this.adjustValue(t,["x","y"]);let e=(0|Math.max(t.width,t.height)).toString().length;this.adjustValue(t,["anchorX","anchorY"],this.defaultMinDifference()+e)}else this.adjustValue(g.target,["x","y","width","height"]);g._processing=!1}}}onCreateRoot(){this._tool=e.rectTool(this._root,this.createMoveCallbacks())}formatBounds(t){return[this.worldToPixel(t[0]),this.worldToPixel(t[1]),this.worldToPixel(t[2]),this.worldToPixel(t[3])]}getBounds(e,o){let i,r=Number.MAX_VALUE,n=-Number.MAX_VALUE,h=Number.MAX_VALUE,s=-Number.MAX_VALUE;function l(t){t.x>n&&(n=t.x),t.x<r&&(r=t.x),t.y>s&&(s=t.y),t.y<h&&(h=t.y)}return this.target.forEach(e=>{let o=t.getWorldOrientedBounds(e);l(o[0]),l(o[1]),l(o[2]),l(o[3])}),e&&(i=r,r=n,n=i),o&&(i=h,h=s,s=i),[cc.v2(r,s),cc.v2(r,h),cc.v2(n,h),cc.v2(n,s)]}onKeyDown(t){if(!this.target)return;let e=Editor.KeyCode(t.which);if("left"!==e&&"right"!==e&&"up"!==e&&"down"!==e)return;let o=t.shiftKey?10:1,i=cc.v2();"left"===e?i.x=-1*o:"right"===e?i.x=o:"up"===e?i.y=o:"down"===e&&(i.y=-1*o),this.recordChanges(),this.topNodes.forEach(t=>{t.position=t.position.add(i)}),this._view.repaintHost()}onKeyUp(t){if(!this.target)return;let e=Editor.KeyCode(t.which);"left"!==e&&"right"!==e&&"up"!==e&&"down"!==e||this.commitChanges()}visible(){return!0}dirty(){return!0}onUpdate(){let e=[];if(1===this.target.length){let o=this.target[0];e=t.getWorldOrientedBounds(o),e=this.formatBounds(e);let r=t.getWorldPosition(o),n=t.getWorldPosition(o.parent);e.anchor=this.worldToPixel(r),e.origin=this.worldToPixel(n),e.localPosition=i(o.position),e.localSize=o.getContentSize()}else{let t=!1,o=!1;this._processing&&(t=this._rect.width<0,o=this._rect.height<0),e=this.getBounds(t,o),e=this.formatBounds(e)}this._tool.setBounds(e)}};