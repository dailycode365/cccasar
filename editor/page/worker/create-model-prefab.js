require("electron").ipcRenderer;const e=require("fire-fs"),t=require("fire-path");module.exports=function(o){const r=Editor.require("app://editor/page/scene-utils/utils/prefab"),n=Editor.require("app://editor/page/scene-utils/utils/node"),i=Editor.require("unpack://engine-dev/cocos2d/core/3d/CCSkinnedMeshRenderer"),l=Editor.require("unpack://engine-dev/cocos2d/core/3d/CCSkeletonAnimation"),s=Editor.require("unpack://engine-dev/cocos2d/core/3d/CCModel");let{gltf:a,meshIDs:d,skeletonIDs:u,modelUuid:c,modelName:m,modelPath:f,scaleFactor:h}=o,p=[],g={},x=a.nodes;for(let o=0;o<x.length;o++){let r=x[o],n=new cc.Node;n.is3DNode=!0,n.name=r.name;let l=r.translation;l&&n.setPosition(l[0],l[1],l[2]);let s=r.rotation;s&&n.setRotation(s[0],s[1],s[2],s[3]);let c=r.scale;if(c&&n.setScale(c[0],c[1],c[2]),void 0!==r.mesh){let o,l=new cc.Mesh;if(l._uuid=d[r.mesh],void 0!==r.skin){o=n.addComponent(i);let e=new cc.Skeleton;e._uuid=u[r.skin],o._skeleton=e}else o=n.addComponent(cc.MeshRenderer);o.mesh=l,o.textures=[];let s=a.meshes[r.mesh].primitives;o.textures.length=s.length;for(let r=0;r<s.length;r++){let i=s[r],l=a.materials[i.material];var C=new cc.Texture2D;let d=l.pbrMetallicRoughness;if(d){if(d.baseColorTexture){let o=a.textures[d.baseColorTexture.index];if(o){let r=a.images[o.source].uri,n=[t.join(t.dirname(f),r),t.join(t.dirname(f),"textures",r),t.join(t.dirname(f),"Textures",r)],i=t.basenameNoExt(r)+".png";if(r!==i){let e=n.map(e=>t.join(t.dirname(e),t.basenameNoExt(r)+".png"));n=n.concat(e)}for(let t=0;t<n.length;t++){let o=n[t];if(e.existsSync(o)&&(C._uuid=Editor.remote.assetdb.fspathToUuid(o),C._uuid))break}}}let o=d.baseColorFactor;if(o){let e=255*(o[0]||1),t=255*(o[1]||1),r=255*(o[2]||1),i=255*(o[3]||1);n.color=cc.color(e,t,r,255),n.opacity=i}}C._uuid||(C._uuid="0275e94c-56a7-410f-bd1a-fc7483f7d14a"),o.textures.push(C)}}p.push(n)}let b=!1;for(let e=0;e<p.length;e++){let t=p[e],o=x[e].children;if(o)for(let e=0;e<o.length;e++)p[o[e]].parent=t;let r=t.getComponent(i);r&&(r._rootBone=p[0],b=!0)}let k=p[0];if(b){let e=k.addComponent(l),t=new s;t._uuid=c,e._model=t}k.scale=h;let _=function(){let e=Object.create(null);return function(t){let o=e[t];return void 0===o?(e[t]=1,t):(e[t]=++o,t+"_"+o)}}(),E=n.getNodePath(k).length+1,q=r.createPrefabFrom(k,e=>{if(e===k)return c;let t=n.getNodePath(e),o=t.slice(E,t.length);return _(o)});q.name=m;let v=Editor.serialize(q);return g[m]=v,g};