const e=require(Editor.url("app://editor/share/sharp")),t=require("child_process").spawn,r=require("fire-fs"),n=require("fire-path"),o=require("async");function i(e,t){return n.join(n.dirname(e),n.basenameNoExt(e)+t)}module.exports=function(a,s){let c=a.src,l=a.dst,p=a.platform,u=a.compressOption;"web-mobile"===p||"web-desktop"===p?p="web":"mac"!==p&&"win32"!==p||(p="native");let m=[],f=u[p];function _(e){s(e,m.map(e=>{if(0===e.name.indexOf("pvrtc_")){let t=8;return"pvrtc_4bits"===e.name?t=8:"pvrtc_2bits"===e.name?t=6:"pvrtc_4bits_rgb"===e.name?t=7:"pvrtc_2bits_rgb"===e.name&&(t=5),`.pvr@${t}`}return 0===e.name.indexOf("etc")?".etc":"."+e.name}))}if(f&&f.formats.length>0?m=f.formats:u.default&&(m=u.default.formats),r.ensureDirSync(n.dirname(l)),0===m.length)return r.copy(c,l,e=>{e&&Editor.error("Failed to copy native asset file %s to %s",c,l),_(e)}),void 0;o.each(m,(r,n)=>{if(-1!==r.name.indexOf("pvrtc_"))return function(e,r,n,o){let a=Editor.url("unpack://static/tools/texture-compress/PVRTexTool/OSX_x86/PVRTexToolCLI");"win32"===process.platform&&(a=Editor.url("unpack://static/tools/texture-compress/PVRTexTool/Windows_x86_64/PVRTexToolCLI.exe"));let s="PVRTC1_4";"pvrtc_4bits"===n.name?s="PVRTC1_4":"pvrtc_4bits_rgb"===n.name?s="PVRTC1_4_RGB":"pvrtc_2bits"===n.name?s="PVRTC1_2":"pvrtc_2bits_rgb"===n.name&&(s="PVRTC1_2_RGB"),r=i(r,".pvr");let c="pvrtc"+n.quality,l=["-i",e,"-o",r,"-squarecanvas","+","-potcanvas","+","-q",c,"-f",`${s},UBN,lRGB`];console.log(`pvrtc compress command :  ${a} ${l.join(" ")}`),function(e,r,n){let o=t(e,r);o.stdout.on("data",function(e){console.log(e.toString())}),o.stderr.on("data",function(e){console.log(e.toString())}),o.on("close",function(){n&&n(null)}),o.on("error",function(e){n&&n(e)})}(a,l,o)}(c,l,r,n);(function(t,r,n,o){let a=e(t),s=".png";if("webp"===n.name)a=a.webp({quality:n.quality}),s=".webp";else if("jpg"===n.name)a=a.jpeg({quality:n.quality}),s=".jpg";else if("png"===n.name){let e=n.quality/10|0;a=a.png({compressionLevel:e})}r=i(r,s),a.toFile(r,e=>{o(e)})})(c,l,r,n)},e=>{_(e)})};