"use strict";const e=require("fire-fs"),t=require("path"),i=require("../libs/advice"),a=require("../libs/manager");exports.template=e.readFileSync(t.join(__dirname,"../template/events.html"),"utf-8"),exports.props=["clip","frame","offset","scale","sample","duration","event"],exports.watch={clip(){try{this.updateEvents()}catch(e){Editor.error(e)}},event(){try{this.updateEvents()}catch(e){Editor.error(e)}}},exports.data=function(){return{shadow:!1,events:[],virtualevents:[]}},exports.methods={t:Editor.T,updateEvents(){for(;this.events.length;)this.events.pop();let e=a.Clip.queryInfo(this.clip.id);(a.Clip.queryEvents(this.clip.id)||[]).forEach(t=>{let i=t.frame*e.sample;-1===this.events.indexOf(i)&&this.events.push(i)})},updateDuration:(e,t,i,a)=>`transform: translateX(${e}px); width: ${t*i*a}px;`,queryEventStyle:(e,t,i)=>`transform: translateX(${e+i*t}px);`,checkHover(e){return this.virtualevents.some(t=>t.frame===e)},_onMouseWheel(e){Math.abs(e.deltaX)>Math.abs(e.deltaY)?i.emit("drag-move",e.deltaX):i.emit("drag-zoom",e.deltaY,Math.round(e.offsetX+this.offset))},_onMouseDown(e){if(1!==e.button&&2!==e.button){let t=Math.round((e.offsetX-(this.$el===e.target?this.offset:0))/this.scale);i.emit("select-frame",t);let a=0;return Editor.UI.startDrag("ew-resize",e,(e,s,r,n,o)=>{a+=isNaN(s)?0:s;let l=Math.round(a/this.scale);i.emit("select-frame",Math.max(l+t,0))},(...e)=>{let s=Math.round(a/this.scale);i.emit("select-frame",Math.max(s+t,0))}),void 0}Editor.UI.startDrag("-webkit-grabbing",e,(e,t,a,s,r)=>{i.emit("drag-move",-Math.round(t))},(...e)=>{})},_onKeyMouseDown(e,t){e.stopPropagation(),2===e.button&&(e.preventDefault(),Editor.Ipc.sendToMain("timeline:menu-event-operation",{frame:t,x:e.pageX,y:e.pageY}))},_onKeyDragStart(e,t){let s=0;this.shadow=!0,this.virtualevents.push({frame:t,offset:0}),Editor.UI.startDrag("ew-resize",e,(e,t,i,a,r)=>{s+=isNaN(t)?0:t;let n=Math.round(s/this.scale);this.virtualevents.forEach(e=>{e.offset=n})},(...e)=>{Math.round(s/this.scale);for(this.shadow=!1;this.virtualevents.length;){let e=this.virtualevents.pop();if(0===e.offset)continue;let t=a.Clip.queryEvents(this.clip.id),i=a.Clip.queryInfo(this.clip.id),s=[];for(let r=0;r<t.length;r++){let n=t[r];Math.round(n.frame*i.sample)===e.frame&&(s.push(a.Clip.deleteEvent(this.clip.id,n)),r--)}s.forEach(t=>{a.Clip.addEvent(this.clip.id,e.frame+e.offset,t.func,t.params)})}this.updateEvents(),i.emit("clip-data-update")})},_onKeyClick(e,t){e.stopPropagation(),e.preventDefault(),i.emit("select-frame",t)},_onKeyDBLClick(e,t){i.emit("change-event",t)}},exports.created=function(){this.updateEvents(),i.on("add-empty-event",()=>{a.Clip.addEvent(this.clip.id,this.frame,"",[]),this.updateEvents(),i.emit("clip-data-update")}),i.on("remove-empty-event",e=>{let t=a.Clip.queryEvents(this.clip.id),i=a.Clip.queryInfo(this.clip.id);for(let s=0;s<t.length;s++){let r=t[s];Math.round(r.frame*i.sample)===e&&(a.Clip.deleteEvent(this.clip.id,r),s--)}this.updateEvents()})};