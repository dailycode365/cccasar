"use strict";const e=require("../libs/dump"),{promisify:t}=require("util"),i=require("../libs/advice"),n=require("../libs/manager");let a=!1,r=function(e){let t=[];for(;t.length;)t.pop();let i=function(e,n,a){a=`${a}/${e.name}`,t.push({id:e.id,path:a,name:e.name,level:n,state:0}),e.children&&e.children.forEach(e=>{i(e,n+1,a)})};return e.forEach(e=>{i(e,0,"")}),t};async function s(){let e=Editor.Selection.curActivate("node");if(!e)return;let n=await t(Editor.Ipc.sendToPanel)("scene","scene:query-animation-hierarchy",e);n=JSON.parse(n),i.emit("change-hierarchy",r(n))}module.exports={ready(){this.vm.init()},reloading(){this.vm.init()},async"animation-clip-changed"(e,i){let a=await t(cc.AssetLibrary.loadJson)(i.data);a._uuid=i.uuid,n.unregister(a),n.register(a)},"animation-state-changed"(e,t){if("play"===t.state){this.vm.paused=!1,(async(e,t,n)=>{if(a)return;a=!0;let r=()=>{Editor.Ipc.sendToPanel("scene","scene:query-animation-time",{rootId:e,clip:t},(e,t)=>{let s=Math.round(t*n);i.emit("change-frame",s),a&&requestAnimationFrame(r)})};requestAnimationFrame(r)})(this.vm.hierarchy[0].id,this.vm.clip.name,this.vm.sample)}else this.vm.paused=!0,a=!1},async"animation-record-changed"(e,a){if(a){this.vm.record=!0;this.vm.hierarchy[0].id;let e=this.vm.clip.name;Editor.Ipc.sendToPanel("scene","scene:change-animation-current-clip",e)}else{this.vm.record=!1;let e=this.vm.clip?this.vm.clip.id:"";if(!e)return;let a=await t(cc.AssetLibrary.loadAsset)(e);n.unregister(a),n.register(a),i.emit("clip-data-update"),this.vm.init()}},"node-component-added"(t,i){i.node===e.root&&"cc.Animation"===i.component&&e.update(()=>{this.vm.updateState()})},"node-component-removed"(t,i){i.node===e.root&&e.update(()=>{this.vm.updateState()})},async"node-component-updated"(t,i){i.node&&i.node===e.root&&await this.vm.updateClips()},"create-nodes-in-scene"(e,t){s()},"paste-nodes-in-scene"(e,t){s()},"duplicate-nodes-in-scene"(e,t){s()},"delete-nodes-in-scene"(e,t){s()},"move-nodes-in-scene"(e,t){s()}};