"use strict";const e=require("jsondiffpatch"),{promisify:t}=require("util");let r=e.create({objectHash:(e,t)=>e.uuid?e.uuid:e.name&&e.attrs?e.name:`$$index:${t}`,arrays:{detectMove:!0}}),i="",n={},l=!1,o=function(e,t,r,i){if(!(i=i||n[e]))throw"timeline 找不到指定的节点数据，无法获取关键帧";if(t){let e=t,n=r;for(let r in i.types){if(i.types[r].name===t){e=r;break}}let l=null;for(let t in i.value.__comps__){let r=i.value.__comps__[t];if(r.type===e){l=r.value;break}}let o=cc.js._getClassById(e);if(!o)return l[n]?l[n].value:null;let a=cc.Class.attr(o,n);if(!a.ctor)return l[n]?l[n].value:null;if(cc.js.isChildClassOf(a.ctor,cc.RawAsset)){let e=l[n].value;return e.uuid?Editor.serialize.asAsset(e.uuid):null}let c=new a.ctor,s=i.types[c.__cid__];if(s&&s.properties){let e=s.properties;for(let t in e)c[t]=l[n].value[t]}return c}"x"===r?r="positionX":"y"===r&&(r="positionY");let l=r,o=null,c=l.substr(0,l.length-1);i.value[c]&&(o=l[l.length-1].toLocaleLowerCase(),l=c),"width"!==l&&"height"!==l||(o=l,l="size");let s=i.value[l],u=s?a[s.type]:null;if(!u)throw`The timeline replication attribute has an error: ${s.type}`;let p=u(s.value);return"position"===r?[p.x,p.y]:o?p[o]:p},a={"cc.Vec2"(e){var t=new cc.Vec2;return t.x=e.x,t.y=e.y,t},"cc.Color"(e){var t=new cc.Color;return t.r=e.r,t.g=e.g,t.b=e.b,t},"cc.Size"(e){var t=new cc.Size;return t.width=e.width,t.height=e.height,t},String:e=>e,Float:e=>e,Boolean:e=>e,Integer:e=>e};module.exports={update:async function(e){clearTimeout(l),l=setTimeout(()=>{(async function(e){let r=Editor.Selection.curSelection("node");i&&-1===r.indexOf(i)&&r.push(i);for(let e=0;e<r.length;e++){let i=r[e],l=await t(Editor.Ipc.sendToPanel)("scene","scene:query-node",i);n[i]=JSON.parse(l)}Object.keys(n).forEach(e=>{-1===r.indexOf(e)&&delete n[e]}),e&&e()})(e)},100)},diff:function(e,t){let i=[],l=n[e];if(!l)return Editor.warn("The cached node data cannot be found."),i;let a=r.diff(l.value,t.value);if(!a)return i;let c=a,s=a&&a.__comps__||{};return delete a.__comps__,Object.keys(c).forEach(r=>{let n=o(e,null,r,t);i.push({component:null,property:r,value:n});let l=Object.keys(c[r].value);l&&l.forEach(e=>{let t,l=r+e[0].toUpperCase()+e.substr(1);switch(l){case"positionX":l="x",t=n[0];break;case"positionY":l="y",t=n[1];break;case"sizeWidth":l="width",t=n.width;break;case"sizeHeight":l="height",t=n.height;break;default:t=n[e]}i.push({component:null,property:l,value:t})})}),Object.keys(s).forEach(r=>{if(!t.value.__comps__[r])return;let n=t.value.__comps__[r].type,l=s[r].value;n&&l&&Object.keys(l).forEach(r=>{let l=o(e,n,r,t);i.push({component:n,property:r,value:l})})}),n[e]=t,i},getProperty:o,get root(){return i},set root(e){i=e},hasAnimaiton:function(e){let t=n[e];if(!t)return!1;for(let e in t.types){let r=t.types[e];if("cc.Animation"===e)return!0;let i=r.extends;if(i)for(let e=0;e<i.length;e++)if("cc.Animation"===i[e])return!0}}},window.abc=n;