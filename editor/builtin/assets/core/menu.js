"use strict";const e=require("electron"),t=require("fire-fs"),s=require("async"),r=require("fire-url"),a=require("./create-menu"),i=require("./search"),l=require("../package.json");function o(){let e=Editor.Selection.contexts("asset");return e.length>0?e[0]:""}function d(e){let s=Editor.assetdb.loadMetaByUuid(e);if(!s)return Editor.info(e+" does not exists in library"),{};if(s.useRawfile())return Editor.info("This is a raw asset, it does not exists in library"),{};let r=s.dests(Editor.assetdb);return 0!==r.length&&t.existsSync(r[0])?{path:r[0],type:s.assetType()}:(Editor.failed("The asset %s is not exists in library",Editor.assetdb.uuidToUrl(e)),{})}function n(e,t,s){let r=a();r.forEach(t=>{t.params&&t.params.push(e)});let i=[{label:Editor.T("ASSETS.folder"),message:"assets:new-asset",params:[{name:"New Folder"},e]}];return i.push({type:"separator"}),i.concat(r)}module.exports={getContextTemplate:function(a,i,c,E){var u=[{label:Editor.T("ASSETS.create"),submenu:n(!0)},{type:"separator"},{label:Editor.T("ASSETS.copy"),enabled:!!E,click(){let e=o();e&&Editor.Ipc.sendToPanel("assets","assets:copy",e)}},{label:Editor.T("ASSETS.paste"),enabled:!!E,click(){let e=o();e&&Editor.Ipc.sendToPanel("assets","assets:paste",e)}},{type:"separator"},{label:Editor.T("ASSETS.rename"),click(){let e=o();e&&Editor.Ipc.sendToPanel(l.name,"assets:rename",e)}},{label:Editor.T("ASSETS.delete"),click(){let e=Editor.Selection.contexts("asset");e.length>0&&Editor.Ipc.sendToPanel(l.name,"assets:delete",e)}}];let S=Editor.assetdb.getAssetBackupPath(Editor.assetdb.uuidToFspath(c));return S&&t.existsSync(S)&&u.push({label:Editor.T("ASSETS.rollback"),click(){let e=Editor.assetdb.uuidToUrl(c);1===Editor.Dialog.messageBox({type:"warning",buttons:["Cancel","OK"],title:"Rollback Asset",message:Editor.T("ASSETS.sure_rollback",{url:e}),defaultId:0,cancelId:0,noLink:!0})&&s.waterfall([function(s){t.readFile(S,(t,r)=>{if(t)return s(t);Editor.assetdb.saveExists(e,r,t=>{if(t)return Editor.error(`Rollback ${e} failed: ${t.stack}`),void 0;Editor.Dialog.messageBox({type:"warning",buttons:["OK"],title:"Rollback Asset",message:Editor.T("ASSETS.rollback_tip",{url:e}),defaultId:0,cancelId:0,noLink:!0})})})}],function(e){e&&Editor.warn(Editor.T("ERROR.assets.rollback"))})}}),u=u.concat([{type:"separator"},{label:Editor.T("ASSETS.find_usages"),click(){let e=o();e&&Editor.Ipc.sendToPanel(l.name,"assets:find-usages",e)}},{label:Editor.isDarwin?Editor.T("ASSETS.reveal_mac"):Editor.T("ASSETS.reveal_win"),click(){let s=o();if(s){let r=Editor.assetdb.uuidToFspath(s);t.existsSync(r)?e.shell.showItemInFolder(r):Editor.failed("Can not found the asset %s",Editor.assetdb.uuidToUrl(s))}}},{type:"separator"},{label:Editor.T("ASSETS.open_in_library"),click(){let e=o();if(e){let{path:t}=d(e);t&&Editor.Ipc.sendToMain("assets:open-text-file-by-path",t)}}},{label:Editor.T("ASSETS.reveal_library"),click(){let t=o();if(t){let{path:s}=d(t);s&&e.shell.showItemInFolder(s)}}},{label:Editor.T("ASSETS.reveal_hierarchy"),visible:"javascript"===a||"coffeescript"===a||"typescript"===a,click(){let e=o();if(e){let t=Editor.assetdb.uuidToUrl(e);Editor.Ipc.sendToPanel("hierarchy","filter",`t:${r.basenameNoExt(t)}`)}}},{label:Editor.T("ASSETS.show_uuid"),click(){let e=o();if(e){let t=Editor.assetdb.uuidToUrl(e),s=Editor.Utils.UuidUtils.compressUuid(e,!0);Editor.info(`${e} (${s}), ${t}`)}}},{type:"separator"},{label:Editor.T("ASSETS.click_assign"),enabled:i,click(){let e=o();e&&Editor.Ipc.sendToPanel("inspector","select-search-asset",e)}}])},getCreateTemplate:n,getSearchTemplate:function(){return i()}};