"use strict";const t=require("fs"),e=require("fire-path"),i=require("async"),s=require("../utils/cache"),r=require("../utils/operation"),o=require("../utils/event");exports.template=t.readFileSync(e.join(__dirname,"../template/search.html"),"utf-8"),exports.components={node:require("./node")},exports.props=["filter"],exports.data=function(){return{nodes:s.queryNodes(),type:null,text:"",uuids:[],showList:[]}},exports.watch={nodes(){this.showNodeFilter()},uuids(){this.showNodeFilter()},filter(){let t=this.filter;if(!t)return;let s=[],a="",n="",l=t.split(" ");t="";for(let e=0,i=l.length;e<i;e++){let i=l[e];if(i)if(/^t:.*/.test(i)){let t=i.substring(2).split(",").map(t=>t.trim());s=s.concat(t)}else/^u:.*/.test(i)?a=i.substring(2):/^used:.*/.test(i)?n=i.substring(5):t=i}clearTimeout(this._searchID),o.emit("start-loading",100),this.uuids=[],this._searchID=null;let d=setTimeout(()=>{o.emit("finish-loading"),d===this._searchID&&Editor.assetdb.queryAssets(null,s,(s,o)=>{d===this._searchID&&(this.text=t.toLowerCase(),a=a.toLowerCase(),n=n.toLowerCase(),i.waterfall([t=>{if(!n||!Editor.Utils.UuidUtils.isUuid(n))return t(),void 0;Editor.assetdb.queryInfoByUuid(n,(e,i)=>{if(e)return t(),void 0;i&&this.isScript(i.type)&&(n=Editor.Utils.UuidUtils.compressUuid(n)),t()})},t=>{o.forEach(t=>{if(t.hidden)return;let i=e.basenameNoExt(t.path);e.extname(t.path);this.validate(i,this.text)&&this.validate(t.uuid,a)&&this.findUsages(t,n)&&this.uuids.push(t.uuid)}),t()}],()=>{Editor.Selection.curSelection("asset").forEach(t=>{r.select(t,!0)})}))})},200);this._searchID=d}},exports.methods={isScript:t=>"javascript"===t||"coffeescript"===t||"typescript"===t,scrollIfNeeded(t){let e=s.queryNode(t);if(!e)return;let i=this.showList.indexOf(e);if(-1==i)return;let r=i*s.lineHeight,o=this.$el.scrollTop+this.$el.clientHeight-s.lineHeight-2;r<this.$el.scrollTop-2?this.$el.scrollTop-=this.$el.scrollTop-2-r:r>=o&&(this.$el.scrollTop+=r-o)},validate:(t,e)=>t.toLowerCase().indexOf(e.toLowerCase())>-1,addShowList(t){-1===this.showList.indexOf(t)&&this.showList.push(t)},removeShowList(t){let e=this.showList.indexOf(t);-1!=e&&this.showList.splice(e,1)},findUsages(e,i){if(!i)return!0;if(i===e.uuid)return!1;if(!e.destPath)return!1;return t.readFileSync(e.destPath).indexOf(i)>=0},onUpdateFilter(t,e,i){if(i&&-1===i.indexOf(t.id))return!1;if(e){let i=t.name.toLowerCase();e=e.toLowerCase();let s=-1!==i.indexOf(e);return s?this.addShowList(t):this.removeShowList(t),s}return this.addShowList(t),!0},showNodeFilter:function(){this.showList=this.nodes.filter(t=>{if(this.uuids&&-1===this.uuids.indexOf(t.id))return!1;if(this.text){let e=t.name.toLowerCase();return this.text=this.text.toLowerCase(),-1!==e.indexOf(this.text)}return!0})},onDragStart(t){t.stopPropagation();let e=Editor.Selection.contexts("asset");if(!e||e.length<=0)return t.preventDefault(),void 0;r.staging(e);let i=[];e.forEach(t=>{i.push(s.queryNode(t))}),Editor.UI.DragDrop.start(t.dataTransfer,{buildImage:!0,effect:"copyMove",type:"asset",items:i.map(t=>({id:t.id,name:t.name}))})},onDragOver(t){t.stopPropagation(),t.preventDefault()},onDragEnd(t){t.stopPropagation(),r.restore(),Editor.UI.DragDrop.end()}};