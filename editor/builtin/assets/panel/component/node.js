"use strict";const e=require("fs"),t=require("path"),i=(require("fire-url"),require("../utils/cache")),n=require("../utils/event"),o=require("../utils/operation"),s=require("../utils/communication");exports.template=e.readFileSync(t.join(__dirname,"../template/node.html"),"utf-8"),exports.props=["start","node"],exports.data=function(){return{style:{"padding-left":15*this.node.level+10,"padding-right":10,transform:`translateY(${this.start*i.lineHeight}px)`},iconUrl:this.node.iconUrl,oldIconUrl:null}},exports.created=function(){this.genIcon()},exports.watch={"node.rename":{handler:function(e,t){e&&!t&&(this.oriName=this.node.name),!e&&t&&this.oriName!=this.node.name&&this.nodeRename()}},"node.level":{handler:function(e,t){this.style["padding-left"]=15*e+10}},"node.iconUrl":{handler:function(e,t){this.oldIconUrl=t,this.genIcon()}}},exports.methods={t:e=>Editor.T(`HIERARCHY.${e}`),onUpdateStyle(e){return this.style.transform=`translateY(${e*i.lineHeight}px)`,this.style},genIcon(){if(this.node.iconUrl)return this.iconUrl=this.node.iconUrl,void 0;let e,t,i=this.node.assetType,n=this.node.id;if("texture"===i)return t='url("'+(e=`thumbnail://${n}?32`)+'")',this.iconUrl=`background-image:${t}`,this.oldIconUrl===this.iconUrl&&(t='url("'+(e+="&_ts="+Date.now())+'")',this.iconUrl=`background-image:${t}`),this.node.iconUrl=this.iconUrl,void 0;if("sprite-frame"===i){var o=this;return Editor.assetdb.queryMetaInfoByUuid(n,(e,t)=>{if(!t)return this.iconUrl=`background-image:${o._getDefaultIcon(i)}`,void 0;var n=JSON.parse(t.json);this.iconUrl=`background-image:${o._getDrawFrameIcon(n)}`,this.node.iconUrl=this.iconUrl}),void 0}this.iconUrl=`background-image:${this._getDefaultIcon(i)}`,this.node.iconUrl=this.iconUrl},_getDefaultIcon(e){let t,i=Editor.metas[e];return i&&i["asset-icon"]?'url("'+(t=i["asset-icon"])+'")':'url("'+(t="packages://assets/static/icon/"+e+".png")+'")'},_getDrawFrameIcon(e){let t,i,n=`thumbnail://${e.rawTextureUuid}?32`,o=e.trimX,s=e.trimY,r=0;e.rotated?(t=e.height,i=e.width,r=270):(t=e.width,i=e.height);let a=`&x=${o}&y=${s}&w=${t}&h=${i}`;0!==r&&(a+=`&rotate=${r}`);let d='url("'+(n+=a)+'")';return this.iconUrl===d&&(d='url("'+(n+="&_ts="+Date.now())+'")'),d},onClick(){if(!this.node.selected||this.node.rename)return this.cancelRename(),void 0;this._renameTimer=setTimeout(()=>{o.rename(this.node.id)},300)},onMouseDown(e){if(e.stopPropagation(),Editor.Selection.setContext("asset",this.node.id),this.cancelRename(),2===e.button)return s.popup("context",{x:e.clientX,y:e.clientY,id:this.node.id,assetType:this.node.assetType,allowAssign:!1,copyEnable:!this.node.readonly&&!this.node.isSubAsset}),void 0},onMouseEnter(){Editor.Selection.hover("asset",this.node.id)},onMouseUp(e){if(Editor.Selection.setContext("asset"),e.ctrlKey||e.metaKey){let e=Editor.Selection.curSelection("asset"),t=e.indexOf(this.node.id);return-1!==t?e.splice(t,1):e.push(this.node.id),Editor.Selection.select("asset",e,!0,!0),void 0}if(e.shiftKey){let e=Editor.Selection.curSelection("asset");if(!e||e.length<=0)return e=this.node.id,Editor.Selection.select("asset",e,!0,!0),void 0;let t=i.queryShowNodes(),n=(i.queryNode(e[0]),t.findIndex(t=>t.id===e[0])),o=t.findIndex(e=>e.id===this.node.id);if(-1===n||-1===o)return console.log("can find uuid"),void 0;if(e[0]===this.node.id)return e=this.node.id,Editor.Selection.select("asset",e,!0,!0),void 0;e=[];let s=n>o?-1:1;for(let i=n;i!==o+s;i+=s){let n=t[i];e.push(n.id)}return Editor.Selection.select("asset",e,!0,!0),void 0}let t=this.node.id;Editor.Selection.select("asset",t,!0,!0)},onMouseLeave(){Editor.Selection.hover("node",null)},cancelRename(e){o.rename(),clearTimeout(this._renameTimer),e&&n.emit("nodes_focus",!0)},onDBClick(e){e.stopPropagation(),e.preventDefault(),clearTimeout(this._renameTimer),1===e.which&&(e.shiftKey||e.metaKey||e.ctrlKey||(this.onOpenAsset(this.node.id),this.cancelRename()))},onIClick(e){e.stopPropagation(),e.preventDefault(),this.cancelRename();let t=!this.node.fold;e.altKey&&o.recFoldNodes(this.node.id,t),o.fold(this.node.id,t)},onIDBClick(e){e.stopPropagation(),e.preventDefault()},onIMouseDown(e){clearTimeout(this._renameTimer),e.stopPropagation(),e.preventDefault()},onIMouseUp(e){e.stopPropagation(),e.preventDefault()},onInputBlur(e){e.stopPropagation(),this.cancelRename()},nodeRename(){let e=o.getRealUrl(this.node.id),t=o.getRealUrl(this.node.id,this.oriName);if(!this.node.name)return Editor.Dialog.messageBox({type:"warning",buttons:[Editor.T("MESSAGE.ok")],title:Editor.T("MESSAGE.warning"),message:Editor.T("MESSAGE.assets.failed_to_move",{srcUrl:t,destUrl:e}),detail:"Can not use empty name",noLink:!0}),void 0;Editor.assetdb.move(t,e,!0,(e,t)=>{e&&(this.node.name=this.oriName)})},onInputKeydown(e){switch(e.stopPropagation(),e.keyCode){case 13:Editor.Ipc.sendToPanel("scene","scene:set-property",{id:this.node.id,path:"name",type:"String",value:e.target.value,isSubProp:!1}),Editor.Ipc.sendToPanel("scene","scene:undo-commit"),this.node.name=e.target.value;case 27:this.cancelRename(!0)}},onInputMouseDown(e){e.stopPropagation(),e.preventDefault()},onInputClick(e){e.stopPropagation(),e.preventDefault()},onOpenAsset(e){Editor.assetdb.queryInfoByUuid(e,(t,n)=>{switch(n.type){case"javascript":case"coffeescript":case"typescript":case"markdown":case"bitmap-font":case"text":Editor.Ipc.sendToMain("assets:open-text-file",e);break;case"scene":Editor.Ipc.sendToMain("scene:open-by-uuid",e);break;case"sprite-frame":Editor.Panel.open("sprite-editor",{uuid:e});break;case"texture":Editor.Ipc.sendToMain("assets:open-texture-file",e);break;case"prefab":Editor.Ipc.sendToAll("scene:enter-prefab-edit-mode",e);break;case"folder":let t=i.queryNode(e);o.fold(t.id,!t.fold)}})}},exports.directives={init(){setTimeout(()=>{if(!this.vm||!this.vm.$el)return;let e=this.vm.$el.getElementsByTagName("input")[0];e&&(e.focus(),e.select())},100)}};