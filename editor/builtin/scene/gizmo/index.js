"use strict";const t=!1,e=require("svg.js");require("svg.filter.js");module.exports=class extends window.HTMLElement{get scale(){return void 0===this._scale?1:this._scale}set scale(t){this._scale=t}get transformTool(){return this._transformTool||"move"}set transformTool(t){this._transformTool=t,this.svg.transform&&this.edit(this.svg.transform.target)}get coordinate(){return this._coordinate||"move"}set coordinate(t){this.svg.transform&&this.edit(this.svg.transform.target),this._coordinate=t}get pivot(){return this._pivot||"move"}set pivot(t){this.svg.transform&&this.edit(this.svg.transform.target),this._pivot=t}get designSize(){return this._designSize}set designSize(t){this._designSize=t}constructor(){super(),this.attachShadow({mode:"open"});let t=document.createElement("style");t.type="text/css",t.textContent=require("fs").readFileSync(require("path").join(__dirname,"./gizmo.css"),"utf-8");let s=document.createElement("div");s.id="svg",this.svg={painter:e(s),design:null,transform:null,select:null},this.shadowRoot.appendChild(t),this.shadowRoot.appendChild(s);let i=cc.engine.getDesignResolutionSize();this._designSize=[i.width,i.height],this.addEventListener("keydown",t=>{this.svg.transform&&this.svg.transform.onKeyDown(t)}),this.addEventListener("keyup",t=>{this.svg.transform&&this.svg.transform.onKeyUp(t)})}connectedCallback(){this.svg.selection=[],this.background=this.svg.painter.group(),this.scene=this.svg.painter.group(),this.foreground=this.svg.painter.group(),this.tabIndex=-1}resize(e,s){if(e<=0&&(console.warn("The SVG width should not be less than 0."),e=0),s<=0&&(console.warn("The SVG height should not be less than 0."),s=0),!e||!s){let t=this.getBoundingClientRect();e=Math.round(e||t.width),s=Math.round(s||t.height)}t&&console.log(`resize: ${e} ${s}`),this.svg.painter.size(e,s),this.svg.painter.spof()}update(){this.svg.transform&&this.svg.transform.update();let t=!!cc.Canvas.instance;this.svg.design&&this.svg.design.visible()!==t&&(t?this.svg.design.show():this.svg.design.hide()),t&&this.updateDesignRect()}repaintHost(){cc.engine&&cc.engine.repaintInEditMode()}sceneToPixel(t){return t}worldToPixel(t){return t}pixelToScene(t){return t}pixelToWorld(t){return t}updateDesignRect(){this.svg.design||(this.svg.design=this.background.rect().back());let t=this.sceneToPixel(cc.v2(0,0)),e=this.sceneToPixel(cc.v2(this.designSize[0],this.designSize[1])),s=Editor.GizmosUtils.snapPixel(t.x),i=Editor.GizmosUtils.snapPixel(t.y),n=Editor.GizmosUtils.snapPixel(e.x)-s,o=Editor.GizmosUtils.snapPixel(e.y)-i;n<0&&(s+=n,n=-n),o<0&&(i+=o,o=-o),this.svg.design.move(s,i).size(n,o).fill("none").stroke({width:1,color:"#a0a",opacity:1})}updateSelectRect(t,e,s,i){this.svg.select||(this.svg.select=this.foreground.rect().front()),this.svg.select.move(Editor.GizmosUtils.snapPixel(t),Editor.GizmosUtils.snapPixel(e)).size(s,i).fill({color:"rgba(0,128,255,0.4)"}).stroke({width:1,color:"#09f",opacity:1})}fadeoutSelectRect(){if(!this.select)return;let t=this.svg.select;t.animate(200,"-").opacity(0).after(()=>{t.remove()}),this.svg.select=null}rectHitTest(t,e,s,i){let n=this.svg.painter.node.createSVGRect();return n.x=t,n.y=e,n.width=s,n.height=i,this.svg.painter.getIntersectionList(n,null).filter(t=>{let e=t.instance;return e&&e.selectable}).map(t=>t.node)}reset(){this.svg.selection=[],this.svg.transform&&(this.svg.transform.remove(),this.svg.transform=null),this.svg.select&&(this.svg.select.remove(),this.svg.select=null),this.svg.design&&(this.svg.design.remove(),this.svg.design=null),this.background.clear(),this.scene.clear(),this.foreground.clear()}updateGizmosState(t,e){if(!t)return;let s=t._components;Object.keys(e).forEach(i=>{t.gizmo&&(t.gizmo[i]=e[i]),s.forEach(t=>{t.gizmo&&(t.gizmo[i]=e[i])})}),this.repaintHost()}select(t){t.forEach(t=>{this.svg.selection.push(t)});let e=[];this.svg.selection.forEach(t=>{let s=cc.engine.getInstanceById(t);s&&(this.updateGizmosState(s,{selecting:!0,editing:!1}),e.push(s))}),this.edit(e)}unselect(t){t.forEach(t=>{let e=this.svg.selection.indexOf(t);-1!==e&&this.svg.selection.splice(e,1);let s=cc.engine.getInstanceById(t);this.updateGizmosState(s,{selecting:!1,editing:!1})});let e=this.svg.selection.map(t=>cc.engine.getInstanceById(t));this.edit(e.filter(t=>!!t))}edit(t){if(0===t.length)return this.svg.transform&&(this.svg.transform.target=[]),this.repaintHost(),void 0;let e;switch(1===t.length&&this.updateGizmosState(t[0],{selecting:!1,editing:!0}),this.transformTool){case"move":e=_Scene.gizmos.move;break;case"rotate":e=_Scene.gizmos.rotate;break;case"scale":e=_Scene.gizmos.scale;break;case"rect":e=_Scene.gizmos.rect}if(!e)return Editor.error("Unknown transform tool %s",this.transformTool),this.repaintHost(),void 0;this.svg.transform instanceof e?this.svg.transform.target=t:(this.svg.transform&&this.svg.transform.remove(),this.svg.transform=new e(this,t),this.svg.transform.update()),this.repaintHost()}hoverin(t){let e=cc.engine.getInstanceById(t);this.updateGizmosState(e,{hovering:!0})}hoverout(t){let e=cc.engine.getInstanceById(t);this.updateGizmosState(e,{hovering:!1})}};