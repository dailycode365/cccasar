var e=require("graceful-fs"),n=require("path"),r=require("../util/utimes");module.exports=function(i,t,o,u){u||(u=o,o={});var c=process.cwd(),f=n.resolve(c,i),a=n.resolve(c,t),s=o.filter,m=o.transform,l=o.overwrite;void 0===l&&(l=o.clobber),void 0===l&&(l=!0);var d=o.errorOnExist,v=o.dereference,p=!0===o.preserveTimestamps,$=0,k=0,E=0,x=!1;function g(r){if($++,s)if(s instanceof RegExp){if(console.warn("Warning: fs-extra: Passing a RegExp filter is deprecated, use a function"),!s.test(r))return R(!0)}else if("function"==typeof s&&!s(r,t))return R(!0);return function(r){var i=v?e.stat:e.lstat;E++,i(r,function(i,t){if(i)return D(i);var o={name:r,mode:t.mode,mtime:t.mtime,atime:t.atime,stats:t};return t.isDirectory()?function(n){var r=n.name.replace(f,a.replace("$","$$$$"));q(r,function(i){if(i)return function(n,r){e.mkdir(r,n.mode,function(i){if(i)return D(i);e.chmod(r,n.mode,function(e){if(e)return D(e);w(n.name)})})}(n,r);w(n.name)})}(o):t.isFile()||t.isCharacterDevice()||t.isBlockDevice()?function(e){var n=e.name.replace(f,a.replace("$","$$$$"));q(n,function(r){r?h(e,n):l?y(n,function(){h(e,n)}):d?D(new Error(n+" already exists")):R()})}(o):t.isSymbolicLink()?function(r){var i=r.replace(f,a);e.readlink(r,function(r,t){if(r)return D(r);(function(r,i){v&&(r=n.resolve(c,r)),q(i,function(t){if(t)return b(r,i);e.readlink(i,function(e,t){return e?D(e):(v&&(t=n.resolve(c,t)),t===r?R():y(i,function(){b(r,i)}))})})})(t,i)})}(r):void 0})}(r)}function h(n,i){var t=e.createReadStream(n.name),o=e.createWriteStream(i,{mode:n.mode});t.on("error",D),o.on("error",D),m?m(t,o,n):o.on("open",function(){t.pipe(o)}),o.once("close",function(){e.chmod(i,n.mode,function(e){if(e)return D(e);p?r.utimesMillis(i,n.atime,n.mtime,function(e){return e?D(e):R()}):R()})})}function y(n,r){e.unlink(n,function(e){return e?D(e):r()})}function w(r){e.readdir(r,function(e,i){return e?D(e):(i.forEach(function(e){g(n.join(r,e))}),R())})}function b(n,r){e.symlink(n,r,function(e){return e?D(e):R()})}function q(n,r){e.lstat(n,function(e){return e&&"ENOENT"===e.code?r(!0):r(!1)})}function D(e){if(!x&&void 0!==u)return x=!0,u(e)}function R(e){if(e||E--,$===++k&&0===E&&void 0!==u)return u(null)}g(f)};