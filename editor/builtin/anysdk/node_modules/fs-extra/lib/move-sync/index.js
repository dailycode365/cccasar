"use strict";const e=require("graceful-fs"),r=require("path"),n=require("../copy-sync").copySync,c=require("../remove").removeSync,t=require("../mkdirs").mkdirsSync;function o(r,t,o){return e.statSync(r).isDirectory()?function(e,r,t){const o={overwrite:!1};t?(c(r),i()):i();function i(){return n(e,r,o),c(e)}}(r,t,o):function(r,n,c){const t=new Buffer(65536),o=c?"w":"wx",i=e.openSync(r,"r"),s=e.fstatSync(i),u=e.openSync(n,o,s.mode);let y=1,f=0;for(;y>0;)y=e.readSync(i,t,0,65536,f),e.writeSync(u,t,0,y),f+=y;return e.closeSync(i),e.closeSync(u),e.unlinkSync(r)}(r,t,o)}module.exports={moveSync:function n(i,s,u){const y=(u=u||{}).overwrite||u.clobber||!1;if(i=r.resolve(i),s=r.resolve(s),i!==s){if(function(n,c){try{return e.statSync(n).isDirectory()&&n!==c&&c.indexOf(n)>-1&&c.split(r.dirname(n)+r.sep)[1].split(r.sep)[0]===r.basename(n)}catch(e){return!1}}(i,s))throw new Error(`Cannot move '${i}' into itself '${s}'.`);t(r.dirname(s)),function(){if(y)try{e.renameSync(i,s)}catch(e){if("ENOTEMPTY"===e.code||"EEXIST"===e.code||"EPERM"===e.code)return c(s),u.overwrite=!1,n(i,s,u);if("EXDEV"!==e.code)throw e;return o(i,s,y)}else try{e.linkSync(i,s),e.unlinkSync(i)}catch(e){if("EXDEV"===e.code||"EISDIR"===e.code||"EPERM"===e.code||"ENOTSUP"===e.code)return o(i,s,y);throw e}}()}}};