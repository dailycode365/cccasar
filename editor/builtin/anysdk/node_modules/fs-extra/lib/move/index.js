"use strict";const e=require("graceful-fs"),r=require("../copy/ncp"),o=require("path"),i=require("../remove").remove,t=require("../mkdirs").mkdirs;function n(r,o,i,t){e.stat(r,(n,d)=>{if(n)return t(n),void 0;d.isDirectory()?c(r,o,i,t):function(r,o,i,t){const n=i?"w":"wx",d=e.createReadStream(r),u=e.createWriteStream(o,{flags:n});function s(){e.unlink(r,t)}d.on("error",n=>{d.destroy(),u.destroy(),u.removeListener("close",s),e.unlink(o,()=>{"EISDIR"===n.code||"EPERM"===n.code?c(r,o,i,t):t(n)})}),u.on("error",e=>{d.destroy(),u.destroy(),u.removeListener("close",s),t(e)}),u.once("close",s),d.pipe(u)}(r,o,i,t)})}function c(e,o,t,n){const c={overwrite:!1};function d(){r(e,o,c,r=>{if(r)return n(r);i(e,n)})}t?i(o,e=>{if(e)return n(e);d()}):d()}module.exports={move:function r(c,d,u,s){"function"==typeof u&&(s=u,u={});const f=!("mkdirp"in u)||u.mkdirp,v=u.overwrite||u.clobber||!1;function m(){o.resolve(c)===o.resolve(d)?setImmediate(s):v?e.rename(c,d,e=>e?"ENOTEMPTY"===e.code||"EEXIST"===e.code?(i(d,e=>{if(e)return s(e);u.overwrite=!1,r(c,d,u,s)}),void 0):"EPERM"===e.code?(setTimeout(()=>{i(d,e=>{if(e)return s(e);u.overwrite=!1,r(c,d,u,s)})},200),void 0):"EXDEV"!==e.code?s(e):(n(c,d,v,s),void 0):s()):e.link(c,d,r=>{if(r)return"EXDEV"===r.code||"EISDIR"===r.code||"EPERM"===r.code||"ENOTSUP"===r.code?(n(c,d,v,s),void 0):(s(r),void 0);e.unlink(c,s)})}f?void t(o.dirname(d),e=>{if(e)return s(e);m()}):m()}};