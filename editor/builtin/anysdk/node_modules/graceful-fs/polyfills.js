var n=require("./fs.js"),c=require("constants"),t=process.cwd,o=null,r=process.env.GRACEFUL_FS_PLATFORM||process.platform;process.cwd=function(){return o||(o=t.call(process)),o};try{process.cwd()}catch(n){}var e=process.chdir;function i(c){return c?function(t,o,r){return c.call(n,t,o,function(n){h(n)&&(n=null),r&&r.apply(this,arguments)})}:c}function u(c){return c?function(t,o){try{return c.call(n,t,o)}catch(n){if(!h(n))throw n}}:c}function f(c){return c?function(t,o,r,e){return c.call(n,t,o,r,function(n){h(n)&&(n=null),e&&e.apply(this,arguments)})}:c}function l(c){return c?function(t,o,r){try{return c.call(n,t,o,r)}catch(n){if(!h(n))throw n}}:c}function s(c){return c?function(t,o){return c.call(n,t,function(n,c){if(!c)return o.apply(this,arguments);c.uid<0&&(c.uid+=4294967296),c.gid<0&&(c.gid+=4294967296),o&&o.apply(this,arguments)})}:c}function a(c){return c?function(t){var o=c.call(n,t);return o.uid<0&&(o.uid+=4294967296),o.gid<0&&(o.gid+=4294967296),o}:c}function h(n){return!n||("ENOSYS"===n.code||!(process.getuid&&0===process.getuid()||"EINVAL"!==n.code&&"EPERM"!==n.code))}process.chdir=function(n){o=null,e.call(process,n)},module.exports=function(n){c.hasOwnProperty("O_SYMLINK")&&process.version.match(/^v0\.6\.[0-2]|^v0\.5\./)&&function(n){n.lchmod=function(t,o,r){n.open(t,c.O_WRONLY|c.O_SYMLINK,o,function(c,t){if(c)return r&&r(c),void 0;n.fchmod(t,o,function(c){n.close(t,function(n){r&&r(c||n)})})})},n.lchmodSync=function(t,o){var r,e=n.openSync(t,c.O_WRONLY|c.O_SYMLINK,o),i=!0;try{r=n.fchmodSync(e,o),i=!1}finally{if(i)try{n.closeSync(e)}catch(n){}else n.closeSync(e)}return r}}(n);n.lutimes||function(n){c.hasOwnProperty("O_SYMLINK")?(n.lutimes=function(t,o,r,e){n.open(t,c.O_SYMLINK,function(c,t){if(c)return e&&e(c),void 0;n.futimes(t,o,r,function(c){n.close(t,function(n){e&&e(c||n)})})})},n.lutimesSync=function(t,o,r){var e,i=n.openSync(t,c.O_SYMLINK),u=!0;try{e=n.futimesSync(i,o,r),u=!1}finally{if(u)try{n.closeSync(i)}catch(n){}else n.closeSync(i)}return e}):(n.lutimes=function(n,c,t,o){o&&process.nextTick(o)},n.lutimesSync=function(){})}(n);n.chown=f(n.chown),n.fchown=f(n.fchown),n.lchown=f(n.lchown),n.chmod=i(n.chmod),n.fchmod=i(n.fchmod),n.lchmod=i(n.lchmod),n.chownSync=l(n.chownSync),n.fchownSync=l(n.fchownSync),n.lchownSync=l(n.lchownSync),n.chmodSync=u(n.chmodSync),n.fchmodSync=u(n.fchmodSync),n.lchmodSync=u(n.lchmodSync),n.stat=s(n.stat),n.fstat=s(n.fstat),n.lstat=s(n.lstat),n.statSync=a(n.statSync),n.fstatSync=a(n.fstatSync),n.lstatSync=a(n.lstatSync),n.lchmod||(n.lchmod=function(n,c,t){t&&process.nextTick(t)},n.lchmodSync=function(){});n.lchown||(n.lchown=function(n,c,t,o){o&&process.nextTick(o)},n.lchownSync=function(){});"win32"===r&&(n.rename=function(c){return function(t,o,r){var e=Date.now(),i=0;c(t,o,function u(f){if(f&&("EACCES"===f.code||"EPERM"===f.code)&&Date.now()-e<6e4)return setTimeout(function(){n.stat(o,function(n,e){n&&"ENOENT"===n.code?c(t,o,u):r(f)})},i),i<100&&(i+=10),void 0;r&&r(f)})}}(n.rename));n.read=function(c){return function(t,o,r,e,i,u){var f;if(u&&"function"==typeof u){var l=0;f=function(s,a,h){if(s&&"EAGAIN"===s.code&&l<10)return l++,c.call(n,t,o,r,e,i,f);u.apply(this,arguments)}}return c.call(n,t,o,r,e,i,f)}}(n.read),n.readSync=function(c){return function(t,o,r,e,i){for(var u=0;;)try{return c.call(n,t,o,r,e,i)}catch(n){if("EAGAIN"===n.code&&u<10){u++;continue}throw n}}}(n.readSync)};