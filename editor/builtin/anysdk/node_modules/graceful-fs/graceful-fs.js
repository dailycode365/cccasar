var e=require("fs"),t=require("./polyfills.js"),n=require("./legacy-streams.js"),r=[],o=require("util");var i=function(){};function u(e){t(e),e.gracefulify=u,e.FileReadStream=d,e.FileWriteStream=E,e.createReadStream=function(e,t){return new d(e,t)},e.createWriteStream=function(e,t){return new E(e,t)};var r=e.readFile;e.readFile=function(e,t,n){"function"==typeof t&&(n=t,t=null);return function e(t,n,o){return r(t,n,function(r){!r||"EMFILE"!==r.code&&"ENFILE"!==r.code?("function"==typeof o&&o.apply(this,arguments),p()):c([e,[t,n,o]])})}(e,t,n)};var o=e.writeFile;e.writeFile=function(e,t,n,r){"function"==typeof n&&(r=n,n=null);return function e(t,n,r,i){return o(t,n,r,function(o){!o||"EMFILE"!==o.code&&"ENFILE"!==o.code?("function"==typeof i&&i.apply(this,arguments),p()):c([e,[t,n,r,i]])})}(e,t,n,r)};var i=e.appendFile;i&&(e.appendFile=function(e,t,n,r){"function"==typeof n&&(r=n,n=null);return function e(t,n,r,o){return i(t,n,r,function(i){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?("function"==typeof o&&o.apply(this,arguments),p()):c([e,[t,n,r,o]])})}(e,t,n,r)});var a=e.readdir;function f(t){return a.apply(e,t)}if(e.readdir=function(e,t,n){var r=[e];"function"!=typeof t?r.push(t):n=t;return r.push(function(e,t){t&&t.sort&&t.sort(),!e||"EMFILE"!==e.code&&"ENFILE"!==e.code?("function"==typeof n&&n.apply(this,arguments),p()):c([f,[r]])}),f(r)},"v0.8"===process.version.substr(0,4)){var s=n(e);d=s.ReadStream,E=s.WriteStream}var l=e.ReadStream;d.prototype=Object.create(l.prototype),d.prototype.open=function(){var e=this;F(e.path,e.flags,e.mode,function(t,n){t?(e.autoClose&&e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n),e.read())})};var y=e.WriteStream;function d(e,t){return this instanceof d?(l.apply(this,arguments),this):d.apply(Object.create(d.prototype),arguments)}function E(e,t){return this instanceof E?(y.apply(this,arguments),this):E.apply(Object.create(E.prototype),arguments)}E.prototype=Object.create(y.prototype),E.prototype.open=function(){var e=this;F(e.path,e.flags,e.mode,function(t,n){t?(e.destroy(),e.emit("error",t)):(e.fd=n,e.emit("open",n))})},e.ReadStream=d,e.WriteStream=E;var m=e.open;function F(e,t,n,r){return"function"==typeof n&&(r=n,n=null),function e(t,n,r,o){return m(t,n,r,function(i,u){!i||"EMFILE"!==i.code&&"ENFILE"!==i.code?("function"==typeof o&&o.apply(this,arguments),p()):c([e,[t,n,r,o]])})}(e,t,n,r)}return e.open=F,e}function c(e){i("ENQUEUE",e[0].name,e[1]),r.push(e)}function p(){var e=r.shift();e&&(i("RETRY",e[0].name,e[1]),e[0].apply(null,e[1]))}o.debuglog?i=o.debuglog("gfs4"):/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&(i=function(){var e=o.format.apply(o,arguments);e="GFS4: "+e.split(/\n/).join("\nGFS4: "),console.error(e)}),/\bgfs4\b/i.test(process.env.NODE_DEBUG||"")&&process.on("exit",function(){i(r),require("assert").equal(r.length,0)}),module.exports=u(require("./fs.js")),process.env.TEST_GRACEFUL_FS_GLOBAL_PATCH&&(module.exports=u(e)),module.exports.close=e.close=function(t){return function(n,r){return t.call(e,n,function(e){e||p(),"function"==typeof r&&r.apply(this,arguments)})}}(e.close),module.exports.closeSync=e.closeSync=function(t){return function(n){var r=t.apply(e,arguments);return p(),r}}(e.closeSync);