const e=require("fire-path"),s=require("fire-fs"),n=require("globby"),i=require("del"),o=["AB2EB9CB1D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C31D34F41700695C92 /* jsb_anysdk_basic_conversions.cpp */; };","AB2EB9CC1D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C51D34F41700695C92 /* jsb_anysdk_protocols_auto.cpp */; };","AB2EB9CD1D34F41700695C92 /* anysdk/manualanysdkbindings.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C71D34F41700695C92 /* manualanysdkbindings.cpp */; };","AB2EB9CE1D34F41700695C92 /* anysdk/SDKManager.cpp in Sources */ = {isa = PBXBuildFile; fileRef = AB2EB9C91D34F41700695C92 /* SDKManager.cpp */; };","ABE457031D35198000F1F400 /* libPluginProtocol.a in Frameworks */ = {isa = PBXBuildFile; fileRef = ABE457021D35198000F1F400 /* libPluginProtocol.a */; };","AB2EB9CB1D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp in Sources */,","AB2EB9CC1D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp in Sources */,","AB2EB9CD1D34F41700695C92 /* anysdk/manualanysdkbindings.cpp in Sources */,","AB2EB9CE1D34F41700695C92 /* anysdk/SDKManager.cpp in Sources */,","ABE457031D35198000F1F400 /* libPluginProtocol.a in Frameworks */,",'AB2EB9C31D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/jsb_anysdk_basic_conversions.cpp; sourceTree = "<group>"; };','AB2EB9C51D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/jsb_anysdk_protocols_auto.cpp; sourceTree = "<group>"; };','AB2EB9C71D34F41700695C92 /* anysdk/manualanysdkbindings.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/manualanysdkbindings.cpp; sourceTree = "<group>"; };','AB2EB9C91D34F41700695C92 /* anysdk/SDKManager.cpp */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.cpp.cpp; path = anysdk/SDKManager.cpp; sourceTree = "<group>"; };','ABE457021D35198000F1F400 /* libPluginProtocol.a */ = {isa = PBXFileReference; lastKnownFileType = archive.ar; name = libPluginProtocol.a; path = ios/anysdk/libPluginProtocol.a; sourceTree = "<group>"; };',"AB2EB9C31D34F41700695C92 /* anysdk/jsb_anysdk_basic_conversions.cpp */,","AB2EB9C51D34F41700695C92 /* anysdk/jsb_anysdk_protocols_auto.cpp */,","AB2EB9C71D34F41700695C92 /* anysdk/manualanysdkbindings.cpp */,","AB2EB9C91D34F41700695C92 /* anysdk/SDKManager.cpp */,","ABE457021D35198000F1F400 /* libPluginProtocol.a */,"],a=[/.* anysdk\/jsb_anysdk_basic_conversions\.cpp.*isa = PBXBuildFile.*/,/.* anysdk\/manualanysdkbindings\.cpp.*isa = PBXBuildFile.*/,/.* anysdk\/SDKManager\.cpp.*isa = PBXBuildFile.*/,/.* anysdk\/jsb_anysdk_protocols_auto\.cpp.*isa = PBXBuildFile.*/,/.* libPluginProtocol\.a.*isa = PBXBuildFile.*/,/ *\S* \/\* anysdk\/manualanysdkbindings.cpp in Sources \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_basic_conversions.cpp in Sources \*\/,/,/ *\S* \/\* anysdk\/SDKManager.cpp in Sources \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_protocols_auto.cpp in Sources \*\/,/,/ *\S* \/\* libPluginProtocol.a in Frameworks \*\/,/,/.* anysdk\/jsb_anysdk_basic_conversions\.cpp.*isa = PBXFileReference.*/,/.* anysdk\/manualanysdkbindings\.cpp.*isa = PBXFileReference.*/,/.* anysdk\/SDKManager\.cpp.*isa = PBXFileReference.*/,/.* anysdk\/jsb_anysdk_protocols_auto\.cpp.*isa = PBXFileReference.*/,/.* libPluginProtocol\.a.*isa = PBXFileReference.*/,/ *\S* \/\* anysdk\/manualanysdkbindings.cpp \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_basic_conversions.cpp \*\/,/,/ *\S* \/\* anysdk\/SDKManager.cpp \*\/,/,/ *\S* \/\* anysdk\/jsb_anysdk_protocols_auto.cpp \*\/,/,/ *\S* \/\* libPluginProtocol.a \*\/,/],r={"/* End PBXBuildFile section */":{range:[0,4]},"/* RootViewController.mm in Sources */,":{range:[5,8]},"/* MobileCoreServices.framework in Frameworks */,":{range:[9,9]},"/* End PBXFileReference section */":{range:[10,14]},"/* AppDelegate.cpp */,":{range:[15,18]},"/* RootViewController.mm */,":{range:[19,19]}};module.exports={init(e){e.on("before-change-files",this.onBuildFinished.bind(this))},onBuildFinished(e,s){if("web-mobile"===e.platform)return this.indexHtml(e),s();if(!e.includeAnySDK&&"mac"===e.platform.toLowerCase())return this.mainJs(e),s();if("android"!==e.platform&&"ios"!==e.platform&&"android-instant"!==e.platform)return s();let n;e=Object.assign({},e),n=Editor.isMainProcess?require("./native-utils").getCocosRoot():Editor.remote.builtinCocosRoot,e.cocosRoot=n,this.ensureFiles(e),this.mainJs(e),this.sdkManager(e),this.xcode(e),this.android(e),s()},ensureFiles(o){let a=e.join(o.cocosRoot,"extensions/anysdk/"),r=e.join(o.dest,"frameworks/runtime-src/Classes/anysdk"),t=[{srcDir:e.join(a,"Classes"),destDir:r}];if(("ios"!==o.platform||o.jailbreakPlatform)&&(t.push({srcDir:e.join(a,"src"),destDir:e.join(o.dest,"src/anysdk")}),t.push({srcDir:e.join(a,"js-bindings"),destDir:r})),"android"===o.platform||"android-instant"===o.platform){let s=e.join(a,"platform/android"),n=e.join(o.dest,"frameworks/runtime-src/proj.android-studio/app"),i={srcDir:s,destDir:n,exludes:[]};i.exludes.push("!"+e.join(s,"libs/libPluginProtocol.jar")),i.exludes.push("!"+e.join(s,"res/drawable/**")),i.exludes.push("!"+e.join(s,"res/layout/**")),i.exludes.push("!"+e.join(s,"res/mipmap-layout/**")),t.push({srcDir:e.join(s,"res/mipmap-layout"),destDir:e.join(n,"res/layout")}),i.exludes.push("!"+e.join(s,"src/**")),t.push(i)}else if("ios"===o.platform){let s=e.join(o.dest,"frameworks/runtime-src/proj.ios_mac/ios/anysdk"),n=e.join(o.cocosRoot,"external/ios");o.jailbreakPlatform?t.push({srcDir:e.join(n,"libs/anysdk/common"),destDir:s}):(t.push({srcDir:e.join(a,"/platform/ios/appstore/js-bindings"),destDir:r}),t.push({srcDir:e.join(a,"/platform/ios/appstore/src"),destDir:e.join(o.dest,"src/anysdk")}),t.push({srcDir:e.join(n,"libs/anysdk/appstore"),destDir:s}))}t.forEach(a=>{let r=[e.join(a.srcDir,"**")];a.exludes&&(r=r.concat(a.exludes)),n.sync(r).forEach(n=>{let r=e.relative(a.srcDir,n),t=e.join(a.destDir,r);s.isDirSync(n)||(o.includeAnySDK?s.copySync(n,t):i.sync(t,{force:!0}))})})},indexHtml(n){if(!n.includeAnySDK)return;let i=e.join(n.dest,"index.html"),o=s.readFileSync(i,"utf8").split("\n");for(let e=0;e<o.length;e++){if(o[e].match(/src="main.js"/)){o.splice(e+1,0,'\n<script charset="utf-8" id="protocols" type="text/javascript">\n  var protocols = document.createElement("script");\n  protocols.onload = function () {\n    anysdk.agentManager.init();\n    anysdk.agentManager.loadAllPlugins(function (code, msg) {\n    });\n  };\n  protocols.src = "http://statics.h5.anysdk.com/protocols/protocols.js";\n  document.body.appendChild(protocols);\n<\/script>\n');break}}s.writeFileSync(i,o.join("\n"))},mainJs(n){let i=e.join(n.dest,"main.js"),o=s.readFileSync(i,"utf8").split("\n");for(let e=0;e<o.length;e++){let s=o[e];s.match(/.*jsb_anysdk.js.*jsb_anysdk_constants.js/)&&(n.includeAnySDK?o[e]=s.replace(/\/\//g,""):-1===s.indexOf("//")&&(o[e]="//"+s))}s.writeFileSync(i,o.join("\n"))},xcode(n){if("ios"!==n.platform)return;let i=e.join(n.dest,`frameworks/runtime-src/proj.ios_mac/${n.projectName}.xcodeproj/project.pbxproj`),t=s.readFileSync(i,"utf8").split("\n"),c=[],l=n.jailbreakPlatform?"common":"appstore";for(let e=0;e<t.length;e++){let s=t[e];if(n.includeAnySDK||!s.match(/\s*PACKAGE_AS,\s*/))if(n.includeAnySDK&&s.match(/\s*PACKAGE_AS_PLACEHOLDER,\s*/))t[e]="PACKAGE_AS,";else{t[e]=s=s.replace(/\/external\/ios\/include\/anysdk\/([a-zA-Z]*)/,`/external/ios/include/anysdk/${l}`);for(let i=0;i<a.length;i++)if(s.match(a[i])){if(!n.includeAnySDK){t.splice(e,1),e--;break}c.push(i)}if(n.includeAnySDK)for(let n in r)if(-1!==s.indexOf(n)){let s=r[n].range[0],i=r[n].range[1];for(let a=s;a<=i;a++)if(-1===c.indexOf(a)){var p=o[a];r[n].after?t.splice(e+1,0,p):t.splice(e,0,p),e++}}}else t[e]="PACKAGE_AS_PLACEHOLDER,"}s.writeFileSync(i,t.join("\n"))},android(n){if(-1===n.platform.indexOf("android"))return;let i=[e.join(n.dest,"frameworks/runtime-src/proj.android-studio/app")];"android-instant"===n.platform&&i.push(e.join(n.dest,"frameworks/runtime-src/proj.android-studio/game")),i.forEach(i=>{let o=e.join(i,"jni/Application.mk"),a=s.readFileSync(o,"utf8").split("\n"),r=!1;for(let e=0;e<a.length;e++){let s=a[e];s.match(/\bUSE_ANY_SDK\b.*:=.*1/)&&(n.includeAnySDK?-1!==s.indexOf("#")&&(a[e]=s.replace(/#/g,""),r=!0):s.match(/.*#.*\bUSE_ANY_SDK\b.*:=.*1/)||(a[e]="#"+s,r=!0))}r&&s.writeFileSync(o,a.join("\n"))})},sdkManager(n){let i=e.join(n.dest,"frameworks/runtime-src/Classes/anysdk/SDKManager.cpp");if(!s.existsSync(i))return;let o=s.readFileSync(i,"utf8");o=(o=(o=(o=o.replace(/std::string oauthLoginServer = ".*";/,`std::string oauthLoginServer = "${n.oauthLoginServer}";`)).replace(/std::string appKey = ".*";/,`std::string appKey = "${n.appKey}";`)).replace(/std::string appSecret = ".*";/,`std::string appSecret = "${n.appSecret}";`)).replace(/std::string privateKey = ".*";/,`std::string privateKey = "${n.privateKey}";`),s.writeFileSync(i,o)}};