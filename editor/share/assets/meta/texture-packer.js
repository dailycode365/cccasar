"use strict";const e=require("fire-fs"),t=require("fire-path"),r=require("plist"),i=require("./sprite-atlas"),s=require("./sprite-frame"),a=/[\{\}]/g,n=/[\\\/]/g;function u(e){let t=(e=e.slice(1,-1)).split(","),r=parseInt(t[0]),i=parseInt(t[1]);return cc.size(r,i)}function l(e){var t=(e=e.slice(1,-1)).split(","),r=parseInt(t[0]),i=parseInt(t[1]);return new cc.Vec2(r,i)}function o(e){return e.split(" ").map(e=>parseInt(e))}function p(e){return e.split(" ").map(e=>parseInt(e))}function h(e){let t=(e=e.replace(a,"")).split(",");return{x:parseInt(t[0]||0),y:parseInt(t[1]||0),w:parseInt(t[2]||0),h:parseInt(t[3]||0)}}module.exports=class extends i{constructor(e){super(e),this.type="Texture Packer"}static validate(t){let i=r.parse(e.readFileSync(t,"utf8"));return void 0!==i.frames&&void 0!==i.metadata}static version(){return"1.2.4"}parse(i){let a=this._assetdb,f=r.parse(e.readFileSync(i,"utf8")),c=f.metadata,d=f.frames,m=t.dirname(i);this._rawTextureFile||(this._rawTextureFile=t.join(m,c.realTextureFileName||c.textureFileName)),this.size=u(c.size);let g={},v=this.getSubMetas(),x=[];for(let e in d){let t,r,i,f,m=d[e],w=!1,y=e.replace(n,"-");y!==e&&x.push(e);let I=v[y];I||(I=new s(a)),g[y]=I,0===c.format?(w=!1,t=m.trimmed,r=`{${m.originalWidth},${m.originalHeight}}`,i=`{${m.offsetX},${m.offsetY}}`,f=`{{${m.x},${m.y}},{${m.width},${m.height}}}`):1===c.format||2===c.format?(w=m.rotated,t=m.trimmed,r=m.sourceSize,i=m.offset,f=m.frame):3===c.format&&(w=m.textureRotated,t=m.trimmed,r=m.spriteSourceSize,i=m.spriteOffset,f=m.textureRect),I.rotated=!!w,I.trimType=t?"custom":"auto",I.spriteType="normal";let S=u(r);I.rawWidth=S.width,I.rawHeight=S.height;let T=l(i);I.offsetX=T.x,I.offsetY=T.y;let $=h(f);if(I.trimX=$.x,I.trimY=$.y,I.width=$.w,I.height=$.h,I.vertices=void 0,m.triangles){let t=o(m.triangles),r=p(m.vertices),i=p(m.verticesUV);if(r.length!==i.length)Editor.warn(`[${e}] vertices.length [${r.length}] is different with verticesUV.length [${i.length}]`);else{I.vertices={triangles:t,x:[],y:[],u:[],v:[]};for(let e=0;e<r.length;e+=2)I.vertices.x.push(r[e]),I.vertices.y.push(r[e+1]);for(let e=0;e<i.length;e+=2)I.vertices.u.push(i[e]),I.vertices.v.push(i[e+1])}}}x.length>0&&Editor.warn("[SpriteAtlas import] Some of the frame keys have been reformatted : "+JSON.stringify(x)),this.updateSubMetas(g)}postImport(e,t){this.rawTextureUuid=this._assetdb.fspathToUuid(this._rawTextureFile);var r=this.getSubMetas();for(var i in r)r[i].rawTextureUuid=this.rawTextureUuid;super.postImport(e,t)}};